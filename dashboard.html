{% extends "base.html" %}
{% block body %}
  {# ‚îÄ‚îÄ Derive display mode from backend ‚îÄ‚îÄ #}
  {% set dm = display_mode|default('paper') %}
  {% set snap = snapshot|default(None) %}

  {% if error_message %}
    <div class="notice warn mb-12">
      <b>Settings input error:</b> {{ error_message }}
    </div>
  {% endif %}

  <div class="dashboard-layout">

    <!-- ===== SIDEBAR ===== -->
    <div class="sidebar">

      <!-- Brand -->
      <div class="sidebar-brand">
        <div class="brand-icon">&#8383;</div>
        <div>
          <h2>{{ product }}</h2>
          <div class="version">
            {% if cfg.symbols and cfg.symbols|length > 1 %}
              {{ cfg.symbols|map('replace', '-USD', '')|join(', ') }} &middot; 5 min
            {% else %}
              {{ cfg.symbol }} &middot; 5 min
            {% endif %}
            <span class="mode-badge {{ dm }}">{{ dm|upper }}</span>
          </div>
        </div>
      </div>

      <!-- Bot Status -->
      <div class="sidebar-status">
        {% if state and state.get('status') == 'paused' %}
          <span class="down fw-600">&#9208; Paused</span>
        {% elif state and state.get('status') == 'ok' %}
          <span class="up fw-600"><span class="live-dot on"></span> Running</span>
        {% elif state and state.get('status') == 'running' %}
          <span class="gold fw-600">&#9203; Training&hellip;</span>
        {% else %}
          <span>&#9203; Starting&hellip;</span>
        {% endif %}
      </div>

      {% if snap %}
        {% if dm == 'dry' and snap.get('paper') %}
        {# ‚îÄ‚îÄ Paper PnL sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
        <div class="sidebar-status mt-6">
          <div class="mono">paper balance</div>
          <div class="mono mt-6" style="font-size:1.15rem;">
            <span class="gold fw-600">${{ '%.2f'|format(snap.get('cash', 0)) }}</span>
            <span class="tag warn tag-sm" style="margin-left:6px;">DRY RUN</span>
          </div>
          <div class="muted mt-6">of ${{ '%.2f'|format(snap.get('starting_cash', 10000)) }} starting cash</div>
        </div>

        <div class="sidebar-status mt-6">
          <div class="mono">paper P&amp;L</div>
          {% set tpnl = snap.get('total_pnl', 0) %}
          {% set tpct = snap.get('total_pnl_pct', 0) %}
          <div class="mono mt-6" style="font-size:1.05rem;">
            <span class="{% if tpnl >= 0 %}up{% else %}danger{% endif %} fw-600">
              {% if tpnl >= 0 %}+{% endif %}${{ '%.2f'|format(tpnl) }}
              <span class="muted" style="font-size:0.82rem;">({% if tpct >= 0 %}+{% endif %}{{ '%.1f'|format(tpct) }}%)</span>
            </span>
          </div>
          <div class="mono mt-6">
            <span class="muted">Realized</span>
            {% set rpnl = snap.get('realized_pnl', 0) %}
            <span class="{% if rpnl >= 0 %}up{% else %}danger{% endif %}">
              {% if rpnl >= 0 %}+{% endif %}${{ '%.2f'|format(rpnl) }}
            </span>
          </div>
        </div>

        <div class="sidebar-status mt-6">
          <div class="mono">paper stats</div>
          <div class="mono mt-6">
            <span class="muted">Trades</span> {{ snap.get('trade_count', 0) }}
            &nbsp;¬∑&nbsp;
            <span class="muted">Open</span> {{ snap.get('open_positions', 0) }}
          </div>
          <div class="mono mt-6">
            <span class="muted">W/L</span>
            <span class="up">{{ snap.get('win_count', 0) }}W</span> /
            <span class="danger">{{ snap.get('loss_count', 0) }}L</span>
            &nbsp;
            {% set wr = snap.get('win_rate', 0) %}
            <span class="{% if wr >= 50 %}up{% elif wr > 0 %}gold{% else %}muted{% endif %}">{{ '%.1f'|format(wr) }}%</span>
          </div>
        </div>

        <div class="sidebar-status mt-6">
          <form class="form-tight inline" method="post" action="/settings/paper-config">
            <div class="config-field">
              <label>Starting cash ($)</label>
              <input name="paper_starting_cash" value="{{ snap.get('starting_cash', 10000) }}" placeholder="10000" style="width:90px;display:inline-block;" />
              <button class="btn-sidebar" type="submit" style="margin-left:4px;">Set</button>
            </div>
          </form>
        </div>

        <div class="sidebar-status mt-6">
          <form class="inline" method="post" action="/settings/paper-reset">
            <button class="btn-sidebar" type="submit"
                    onclick="return confirm('Reset paper balance to starting cash?')">
              ‚Ü∫ Reset Paper Balance
            </button>
          </form>
        </div>

        {% else %}
        {# ‚îÄ‚îÄ Real wallet sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
        {% if display_mode != 'paper' %}
        <div class="sidebar-status mt-6">
          <div class="mono">wallet gas</div>
          <div class="mono mt-6">
            <span class="muted">{{ snap.get('native_gas_symbol','POL') }}</span>
            <span class="{% if snap.get('native_gas_balance', 0) >= (native_gas_min|default(0.15)) %}up{% else %}danger{% endif %}">
              {{ '%.4f'|format(snap.get('native_gas_balance', 0)) }}
            </span>
            {% if snap.get('native_gas_balance', 0) < (native_gas_min|default(0.15)) %}
              <span class="tag warn tag-sm">low</span>
            {% endif %}
          </div>
          <div class="muted mt-6">Low gas can break redeem/withdraw.</div>
        </div>
        {% endif %}

        {% if wallet_address %}
        <div class="sidebar-status mt-6">
          <div class="mono">bot wallet</div>
          <div class="mono mt-6" style="font-size:0.72rem;word-break:break-all;">
            <a href="https://polygonscan.com/address/{{ wallet_address }}" target="_blank" rel="noopener" title="View on Polygonscan" style="color:inherit;text-decoration:underline dotted;">{{ wallet_address }}</a>
            <button type="button" onclick="navigator.clipboard.writeText('{{ wallet_address }}').then(()=>{this.textContent='‚úì';setTimeout(()=>this.textContent='üìã',1500)})" style="background:none;border:none;cursor:pointer;font-size:0.9rem;padding:2px 4px;" title="Copy address">üìã</button>
          </div>
          <div class="muted mt-6">Send POL gas to this address.</div>
        </div>
        {% endif %}
        {% endif %}
      {% endif %}

      <div class="sidebar-section">
        <div class="sidebar-section-header">Wallet</div>
        <form class="inline" method="get" action="/reconfigure">
          <button class="btn-sidebar" type="submit">open wallet setup</button>
        </form>
        <div class="muted mt-6">Set private key, wallet type, and funder address.</div>
      </div>

      <!-- Bot Controls -->
      <div class="sidebar-btns">
        {% if state and state.get('status') == 'paused' %}
          <form class="inline" method="post" action="/resume">
            <button class="btn-sidebar start" type="submit">&#9654; Start</button>
          </form>
        {% else %}
          <form class="inline" method="post" action="/pause">
            <button class="btn-sidebar stop" type="submit">&#9632; Stop</button>
          </form>
        {% endif %}
      </div>

      <!-- Mode Switcher -->
      <div class="sidebar-section">
        <div class="sidebar-section-header">Mode</div>
        <div class="mode-switcher">
          <form class="inline" method="post" action="/mode/paper" hx-post="/mode/paper" hx-swap="none">
            <button class="mode-btn{% if dm == 'paper' %} active active-paper{% endif %}" type="submit">paper</button>
          </form>
          <form class="inline" method="post" action="/mode/dry" hx-post="/mode/dry" hx-swap="none">
            <button class="mode-btn{% if dm == 'dry' %} active{% endif %}" type="submit">dry</button>
          </form>
          <form class="inline" method="post" action="/mode/live" hx-post="/mode/live" hx-swap="none">
            <button class="mode-btn{% if dm == 'live' %} active active-live{% endif %}" type="submit">live</button>
          </form>
        </div>
      </div>

      <!-- Trading Settings -->
      <form class="form-tight" method="post" action="/settings/polymarket">
        <div class="sidebar-section">
          <div class="sidebar-section-header">Trading</div>

          <div class="toggle-wrap">
            <span class="toggle-label">Auto-trade</span>
            <label class="toggle">
              <input type="checkbox" name="enabled" value="true" aria-label="Auto-trade" {% if poly_cfg and poly_cfg.enabled %}checked{% endif %}>
              <span class="slider"></span>
            </label>
          </div>

          <div class="toggle-wrap">
            <span class="toggle-label">Dry-run</span>
            <label class="toggle">
              <input type="checkbox" name="dry_run" value="true" aria-label="Dry-run" {% if poly_cfg and poly_cfg.dry_run %}checked{% endif %}>
              <span class="slider"></span>
            </label>
          </div>

          <div class="toggle-wrap">
            <span class="toggle-label">Arb-first</span>
            <label class="toggle" title="High-confidence mode: buys BOTH sides (UP + DOWN) only when the orderbook briefly makes it cheap enough.">
              <input type="checkbox" name="arb_enabled" value="true" aria-label="Arb-first" {% if poly_cfg and poly_cfg.arb_enabled %}checked{% endif %}>
              <span class="slider"></span>
            </label>
          </div>

          <div class="config-field">
            <label>Min edge (cents)</label>
            <input name="arb_min_edge_cents" value="{{ poly_cfg.arb_min_edge_cents if poly_cfg else '1.0' }}" placeholder="e.g. 1.0" />
            <div class="field-hint">
              Only trade when UP ask + DOWN ask is at least this much below $1.00. Higher = fewer trades.
            </div>
          </div>

          <details class="mt-6">
            <summary class="small muted">Advanced arb buffers</summary>
            <div class="config-field mt-6">
              <label>Taker fee (bps)</label>
              <input name="arb_taker_fee_bps" value="{{ poly_cfg.arb_taker_fee_bps if poly_cfg else '0' }}" placeholder="e.g. 0" />
            </div>
            <div class="config-field">
              <label>Slippage buffer (bps)</label>
              <input name="arb_slippage_bps" value="{{ poly_cfg.arb_slippage_bps if poly_cfg else '0' }}" placeholder="e.g. 0" />
              <div class="field-hint">Extra safety margin. 10 bps = 0.10%.</div>
            </div>
          </details>

          <div class="toggle-wrap">
            <span class="toggle-label">Snipe mode</span>
            <label class="toggle" title="Late-entry strategy: near window close, check if BTC already moved vs window open price. Higher accuracy when triggered.">
              <input type="checkbox" name="snipe_enabled" value="true" aria-label="Snipe mode" {% if (overrides and overrides.get('C5_SNIPE_ENABLED') in ['true','True','1']) or (not overrides or not overrides.get('C5_SNIPE_ENABLED')) %}checked{% endif %}>
              <span class="slider"></span>
            </label>
          </div>

          <details class="mt-6">
            <summary class="small muted">Snipe settings</summary>
            <div class="config-field mt-6">
              <label>Lead seconds</label>
              <input name="snipe_lead_seconds" value="{{ overrides.get('C5_SNIPE_LEAD_SECONDS', '10') if overrides else '10' }}" placeholder="e.g. 10" />
              <div class="field-hint">How many seconds before window close to fire the snipe check.</div>
            </div>
            <div class="config-field">
              <label>Min delta (%)</label>
              <input name="snipe_min_delta" value="{{ overrides.get('C5_SNIPE_MIN_DELTA_PCT', '0.02') if overrides else '0.02' }}" placeholder="e.g. 0.02" />
              <div class="field-hint">Minimum price move (%) to trigger. 0.02 = 0.02%.</div>
            </div>
            <div class="config-field">
              <label>Snipe bet multiplier</label>
              <input name="snipe_bet_multiplier" value="{{ overrides.get('C5_POLY_SNIPE_BET_MULTIPLIER', '2.0') if overrides else '2.0' }}" placeholder="e.g. 2.0" />
              <div class="field-hint">Snipe trades are sized at this multiple of normal. 2.0 = double. Min 1.0.</div>
            </div>
          </details>

          <div class="toggle-wrap">
            <span class="toggle-label">Delta-first mode</span>
            <label class="toggle" title="v0.5.0: Disable ML-only trades. Snipe at T-10s using live Chainlink delta becomes the sole entry mechanism. Validated by the most profitable open-source Polymarket bot.">
              <input type="checkbox" name="delta_first" value="true" aria-label="Delta-first mode" {% if (overrides and overrides.get('C5_DELTA_FIRST') in ['true','True','1']) or (not overrides or not overrides.get('C5_DELTA_FIRST')) %}checked{% endif %}>
              <span class="slider"></span>
            </label>
          </div>

          <div class="toggle-wrap">
            <span class="toggle-label">Delta pricing</span>
            <label class="toggle" title="Gate snipe trades by ask vs. delta tier ($0.52‚Äì$0.97). Skips if ask exceeds the tier for the observed delta (too expensive). Prevents overpaying on small moves.">
              <input type="checkbox" name="delta_pricing" value="true" aria-label="Delta pricing" {% if (overrides and overrides.get('C5_DELTA_PRICING') in ['true','True','1']) or (not overrides or not overrides.get('C5_DELTA_PRICING')) %}checked{% endif %}>
              <span class="slider"></span>
            </label>
          </div>

          <div class="toggle-wrap">
            <span class="toggle-label">Auto-redeem</span>
            <label class="toggle" title="After wins resolve, auto-claim collateral on-chain (Polygon). Costs gas.">
              <input type="checkbox" name="auto_redeem" value="true" aria-label="Auto-redeem" {% if (not overrides) or ('C5_POLY_AUTO_REDEEM_ENABLED' not in overrides) or (overrides.get('C5_POLY_AUTO_REDEEM_ENABLED') in ['true','True','1']) %}checked{% endif %}>
              <span class="slider"></span>
            </label>
          </div>

          <div class="field-hint mt-6">
            Auto-redeem is <b>ON by default</b>. It sends an on-chain transaction (Polygon) and costs gas.
            Keep a little MATIC in the wallet. You can disable this anytime.
          </div>

          <div class="toggle-wrap">
            <span class="toggle-label">Force GTC Orders</span>
            <label class="toggle" title="Disables FOK safety. Places resting limit orders that may not fill immediately. Increases risk.">
              <input type="checkbox" name="force_gtc" value="true" aria-label="Force GTC Orders" {% if overrides and (overrides.get('C5_POLY_FORCE_GTC') in ['true','True','1']) %}checked{% endif %}>
              <span class="slider"></span>
            </label>
          </div>

          <div class="field-hint mt-6">
            <b>Warning:</b> Disables FOK (Fill-Or-Kill) safety. If liquidity is thin, your order will rest on the book and may fill at a bad time. Use only if you want to "continue with the risk" instead of skipping trades.
          </div>

          <div class="toggle-wrap">
            <span class="toggle-label">High-risk</span>
            <label class="toggle" title="Unlocks higher % sizing. Dangerous.">
              <input type="checkbox" name="high_risk" value="true" aria-label="High-risk" {% if overrides and (overrides.get('C5_POLY_HIGH_RISK_MODE') in ['true','True','1']) %}checked{% endif %}>
              <span class="slider"></span>
            </label>
          </div>

          <div class="toggle-wrap">
            <span class="toggle-label">Expert/UNSAFE</span>
            <label class="toggle" title="Unlocks up to 100% bet sizing. Extremely dangerous.">
              <input type="checkbox" name="expert_mode" value="true" aria-label="Expert/UNSAFE" {% if overrides and (overrides.get('C5_POLY_EXPERT_MODE') in ['true','True','1']) %}checked{% endif %}>
              <span class="slider"></span>
            </label>
          </div>

          <div class="config-field">
            <label>Confirm Expert</label>
            <input name="expert_ack" value="" placeholder="Type: I UNDERSTAND" />
            <div class="field-hint">
              Required <b>once</b> to enable Expert mode. Matching is case-insensitive.
              Expert removes the Bet% cap (up to 100%). You can blow up your account fast.
            </div>
          </div>

          <div class="config-field">
            <label>Max $ / trade</label>
            <input name="max_usdc" value="{{ poly_cfg.max_usdc_per_trade if poly_cfg else '' }}" placeholder="e.g. 5" />
          </div>

          <div class="config-field">
            <label>Bet mode</label>
            <select name="bet_mode" title="Bet sizing mode">
              <option value="fixed" {% if not poly_cfg or poly_cfg.bet_mode == 'fixed' %}selected{% endif %}>Fixed $</option>
              <option value="percent" {% if poly_cfg and poly_cfg.bet_mode == 'percent' %}selected{% endif %}>% of bal</option>
              <option value="kelly" {% if poly_cfg and poly_cfg.bet_mode == 'kelly' %}selected{% endif %}>Kelly (fractional)</option>
            </select>
          </div>

          <div class="config-field">
            <label>Kelly fraction (0.0‚Äì1.0)</label>
            <input name="kelly_fraction" value="{{ poly_cfg.kelly_fraction if poly_cfg and poly_cfg.kelly_fraction is not none else ((overrides.get('C5_POLY_KELLY_FRACTION') if overrides else '') or '0.25') }}" placeholder="0.25" />
            <div class="field-hint">
              0.25 = <b>1/4 Kelly</b> (recommended). 0.5 is more aggressive. 0 disables Kelly sizing.
            </div>
          </div>

          <div class="config-field">
            <label>Bet %</label>
            <input name="bet_percent" value="{{ poly_cfg.bet_percent if poly_cfg else '5' }}" placeholder="e.g. 5" />
            <div class="field-hint">Capped at 10% (High-risk: 50%, Expert/UNSAFE: 100%).</div>
          </div>

          <div class="toggle-wrap">
            <span class="toggle-label">Book depth guard</span>
            <label class="toggle" title="Require sufficient orderbook depth before placing trades. Skips thin orderbooks to avoid slippage.">
              <input type="checkbox" name="require_book_depth" value="true" aria-label="Book depth guard" {% if overrides and (overrides.get('C5_POLY_REQUIRE_BOOK_DEPTH') in ['true','True','1']) %}checked{% endif %}>
              <span class="slider"></span>
            </label>
          </div>

          <details class="mt-6">
            <summary class="small muted">Timing &amp; edge</summary>
            <div class="config-field mt-6">
              <label>Trade lead (seconds)</label>
              <input name="trade_lead_seconds" value="{{ overrides.get('C5_POLY_TRADE_LEAD_SECONDS', '30') if overrides else '30' }}" placeholder="e.g. 30" />
              <div class="field-hint">How many seconds before window close to place the ML trade.</div>
            </div>
            <div class="config-field">
              <label>Cooldown (seconds)</label>
              <input name="cooldown_seconds" value="{{ overrides.get('C5_POLY_COOLDOWN_SECONDS', '300') if overrides else '300' }}" placeholder="e.g. 300" />
              <div class="field-hint">Min seconds between trades. 300 = one per window.</div>
            </div>
            <div class="config-field">
              <label>Edge gate (0&ndash;1)</label>
              <input name="edge_min" value="{{ overrides.get('C5_POLY_EDGE_MIN', '0.0') if overrides else '0.0' }}" placeholder="e.g. 0.02" />
              <div class="field-hint">Min edge (model p &minus; market ask) required for ML trades. 0 = disabled. Snipe bypasses this.</div>
            </div>

            <div class="config-field">
              <label>Ask source</label>
              {% set am = (overrides.get('C5_POLY_ASK_MODE') if overrides else '') or 'prefer_live' %}
              <select name="ask_mode" title="How to pick base ask price">
                <option value="prefer_live" {% if am == 'prefer_live' %}selected{% endif %}>Prefer live orderbook</option>
                <option value="legacy_max" {% if am == 'legacy_max' %}selected{% endif %}>Legacy: max(live, gamma)</option>
              </select>
              <div class="field-hint">Prefer-live usually increases fills and avoids stale Gamma high prices. Legacy may skip fewer trades when live book glitches.</div>
            </div>
          </details>

          <input type="hidden" name="market_query" value="{{ poly_cfg.market_query if poly_cfg else 'Bitcoin Up or Down' }}" />
          <input type="hidden" name="outcome_up" value="{{ poly_cfg.outcome_up if poly_cfg else 'Up' }}" />
          <input type="hidden" name="outcome_down" value="{{ poly_cfg.outcome_down if poly_cfg else 'Down' }}" />
        </div>

        <button type="submit" class="btn-save-sidebar">Save Trading</button>
      </form>

      <!-- Wallet Care (noob-friendly) -->
      <form class="form-tight" method="post" action="/settings/gas">
        <div class="sidebar-section">
          <div class="sidebar-section-header">Wallet care</div>

          <div class="toggle-wrap">
            <span class="toggle-label">Auto top-up gas</span>
            <label class="toggle" title="Optional/advanced: if enabled, the bot will try to buy a little gas using USDC when low. This still requires some existing gas in the wallet.">
              <input type="checkbox" name="gas_topup_enabled" value="true" aria-label="Auto top-up gas" {% if overrides and (overrides.get('C5_GAS_TOPUP_ENABLED') in ['true','True','1']) %}checked{% endif %}>
              <span class="slider"></span>
            </label>
          </div>

          <div class="config-field">
            <label>Target gas ({{ (overrides.get('C5_NATIVE_GAS_SYMBOL') if overrides else '') or 'POL' }})</label>
            <input name="gas_topup_target_native" value="{{ (overrides.get('C5_GAS_TOPUP_TARGET_NATIVE') if overrides else '') or '1.0' }}" placeholder="e.g. 1.0" />
            <div class="field-hint">Bot will try to maintain this balance (best-effort).</div>
          </div>

          <div class="config-field">
            <label>Max spend (USDC)</label>
            <input name="gas_topup_max_usdc" value="{{ (overrides.get('C5_GAS_TOPUP_MAX_USDC') if overrides else '') or '5' }}" placeholder="e.g. 5" />
            <div class="field-hint">Safety cap for buying gas token.</div>
          </div>

          <details>
            <summary class="setup-details-toggle">Advanced gas settings</summary>
            <div class="config-field mt-10">
              <label>Gas token symbol</label>
              <input name="native_gas_symbol" value="{{ (overrides.get('C5_NATIVE_GAS_SYMBOL') if overrides else '') or 'POL' }}" placeholder="POL" />
            </div>
            <div class="config-field">
              <label>Low gas warning threshold</label>
              <input name="native_gas_min" value="{{ (overrides.get('C5_NATIVE_GAS_MIN') if overrides else '') or '0.15' }}" placeholder="0.15" />
              <div class="field-hint">Below this, the dashboard warns loudly.</div>
            </div>
            <div class="field-hint">Note: swapping still needs some existing gas. If gas is near-zero, send a small amount manually first.</div>
          </details>
        </div>
        <button type="submit" class="btn-save-sidebar">Save Wallet Care</button>
      </form>

      <!-- Signal Sensitivity -->
      <form class="form-tight" method="post" action="/settings/model">
        <div class="sidebar-section">
          <div class="sidebar-section-header">Signal</div>
          <div class="config-field">
            <label>Threshold (0.50&ndash;0.99)</label>
            <input name="confidence_threshold" placeholder="0.55" value="{{ (overrides.get('C5_CONFIDENCE_THRESHOLD') if overrides else '') or cfg.confidence_threshold }}" />
          </div>

          <div class="config-field">
            <label>Ensemble weight (0&ndash;1)</label>
            <input name="ensemble_weight" value="{{ (overrides.get('C5_ENSEMBLE_WEIGHT') if overrides else '') or cfg.ensemble_weight }}" placeholder="0.6" />
            <div class="field-hint">Model vs delta blend. 0.6 = 60% model, 40% delta. Higher = more ML.</div>
          </div>

          <div class="config-field">
            <label>Quiet hours (UTC)</label>
            <input name="quiet_hours_utc" value="{{ (overrides.get('C5_QUIET_HOURS_UTC') if overrides else '') or cfg.quiet_hours_utc }}" placeholder="e.g. 2-6" />
            <div class="field-hint">Skip ML trades during these UTC hours (e.g. "2-6" or "0-4,22-23"). Leave blank to trade 24/7.</div>
          </div>

          <details class="mt-6">
            <summary class="small muted">Data &amp; feed</summary>

            <div class="toggle-wrap mt-6">
              <span class="toggle-label">Incremental candles</span>
              <label class="toggle" title="Fetch only new Coinbase candles instead of refetching the full lookback each run (faster, fewer failures).">
                <input type="checkbox" name="incremental_candles" value="true" aria-label="Incremental candles"
                       {% if (not overrides) or ('C5_COINBASE_INCREMENTAL_CANDLES' not in overrides) or (overrides.get('C5_COINBASE_INCREMENTAL_CANDLES') in ['true','True','1']) %}checked{% endif %}>
                <span class="slider"></span>
              </label>
            </div>

            <div class="toggle-wrap">
              <span class="toggle-label">RTDS JSON PING</span>
              <label class="toggle" title="Polymarket recommends sending JSON PING messages every ~5s to keep RTDS connections healthy.">
                <input type="checkbox" name="rtds_json_ping_enabled" value="true" aria-label="RTDS JSON PING"
                       {% if (not overrides) or ('C5_RTDS_JSON_PING_ENABLED' not in overrides) or (overrides.get('C5_RTDS_JSON_PING_ENABLED') in ['true','True','1']) %}checked{% endif %}>
                <span class="slider"></span>
              </label>
            </div>

            <div class="config-field">
              <label>RTDS ping interval (sec)</label>
              <input name="rtds_json_ping_interval_sec" value="{{ (overrides.get('C5_RTDS_JSON_PING_INTERVAL_SEC') if overrides else '') or '5' }}" placeholder="e.g. 5" />
            </div>

            <div class="config-field">
              <label>Chainlink stale threshold (sec)</label>
              <input name="chainlink_stale_threshold_sec" value="{{ (overrides.get('C5_CHAINLINK_STALE_THRESHOLD_SEC') if overrides else '') or '30' }}" placeholder="e.g. 30" />
              <div class="field-hint">If the Chainlink price feed is older than this, the bot treats it as stale (affects snipe + oracle alignment).</div>
            </div>
          </details>
        </div>
        <button type="submit" class="btn-save-sidebar">Save Signal</button>
      </form>

      <!-- Risk Rails -->
      <form class="form-tight" method="post" action="/settings/risk">
        <div class="sidebar-section">
          <div class="sidebar-section-header">Risk rails</div>
          <div class="field-hint mb-6">Circuit breakers that auto-pause trading to protect capital.</div>

          <div class="config-field">
            <label>Daily loss limit (%)</label>
            <input name="risk_daily_loss_pct" value="{{ overrides.get('C5_RISK_DAILY_LOSS_PCT', '10') if overrides else '10' }}" placeholder="e.g. 10" />
            <div class="field-hint">Pause trading if daily losses exceed this % of starting balance. 0 = disabled.</div>
          </div>

          <div class="config-field">
            <label>Consec. loss limit</label>
            <input name="risk_consec_loss_limit" value="{{ overrides.get('C5_RISK_CONSEC_LOSS_LIMIT', '5') if overrides else '5' }}" placeholder="e.g. 5" />
            <div class="field-hint">Pause after this many consecutive losses. 0 = disabled.</div>
          </div>

          <div class="config-field">
            <label>Unfilled ratio (0&ndash;1)</label>
            <input name="risk_unfilled_ratio" value="{{ overrides.get('C5_RISK_UNFILLED_RATIO', '0.5') if overrides else '0.5' }}" placeholder="e.g. 0.5" />
            <div class="field-hint">Pause if more than this fraction of recent orders go unfilled. 0 = disabled.</div>
          </div>

          <div class="config-field">
            <label>Unfilled lookback</label>
            <input name="risk_unfilled_lookback" value="{{ overrides.get('C5_RISK_UNFILLED_LOOKBACK', '20') if overrides else '20' }}" placeholder="e.g. 20" />
            <div class="field-hint">Number of recent orders to check for unfilled ratio.</div>
          </div>

          <div class="config-field">
            <label>Auto-resume (minutes)</label>
            <input name="risk_auto_resume_minutes" value="{{ overrides.get('C5_RISK_AUTO_RESUME_MINUTES', '60') if overrides else '60' }}" placeholder="e.g. 60" />
            <div class="field-hint">After a risk pause, auto-resume trading after this many minutes. 0 = manual resume only.</div>
          </div>
        </div>
        <button type="submit" class="btn-save-sidebar">Save Risk Rails</button>
      </form>

      <!-- Symbols -->
      <form class="form-tight" method="post" action="/settings/symbols">
        <div class="sidebar-section">
          <div class="sidebar-section-header">Symbols</div>
          <div class="field-hint mb-6">Which 5-minute Up/Down markets to trade. Comma-separated Coinbase pair names.</div>

          <div class="config-field">
            <label>Active symbols</label>
            <input name="symbols" value="{{ cfg.symbols|join(', ') if cfg.symbols else cfg.symbol }}" placeholder="e.g. BTC-USD, ETH-USD" />
            <div class="field-hint">
              Available: BTC-USD, ETH-USD, SOL-USD, XRP-USD.
              Default: BTC-USD only.
            </div>
          </div>

          <input type="hidden" name="primary" value="{{ cfg.symbol }}" />
        </div>
        <button type="submit" class="btn-save-sidebar">Save Symbols</button>
      </form>

      <!-- Sidebar Footer -->
      <div class="sidebar-footer">
        <!-- Auto-update notification -->
        <div id="update-banner" style="display:none" class="update-banner">
          <div class="update-banner-inner">
            <div class="update-icon">&#x2B06;</div>
            <div class="update-text">
              <strong>Update available</strong>
              <span id="update-version-info" class="mono small"></span>
            </div>
          </div>
          <button id="update-approve-btn" class="btn-update" onclick="approveUpdate()">
            Update now
          </button>
          <div id="update-progress" style="display:none" class="update-progress">
            <div class="update-progress-bar"><div id="update-progress-fill" class="update-progress-fill"></div></div>
            <span id="update-progress-text" class="small muted">Downloading...</span>
          </div>
          <details class="mt-6">
            <summary class="small muted">Release notes</summary>
            <div id="update-notes" class="small mono mt-6" style="max-height:120px;overflow-y:auto;white-space:pre-wrap;color:var(--muted)"></div>
          </details>
        </div>
        <div class="sidebar-version-row">
          <span class="sidebar-version mono small">v{{ app_version|default('?') }}</span>
          <button id="check-update-btn" class="btn-check-update" onclick="manualCheckUpdate()" title="Check for updates">&#8635; Check</button>
        </div>
        <div id="update-check-result" class="small mono mt-4" style="display:none"></div>
        <a class="logout-link" href="/logout">&#8599; Logout</a>
      </div>
    </div>

    <!-- ===== MAIN CONTENT ===== -->
    <div class="main-content">

      {% if dm == 'live' %}
        <div class="notice danger mb-12">
          <div>
            <b>LIVE mode is enabled.</b> Real orders may be placed. Not financial advice. You can lose money.
            <span class="muted">Auto-redeem is enabled by default (can be disabled). Manual redeem may still be required in some cases.</span>
            <span class="muted">See legal/RISK_DISCLOSURE.md.</span>
          </div>
          <span class="badge">risk</span>
        </div>
      {% elif dm == 'dry' %}
        <div class="notice warn mb-12">
          <div>
            <b>DRY-RUN mode.</b> The bot will simulate trades but should not place real orders.
            Confirm markets/outcomes match before going LIVE.
          </div>
          <span class="badge">dry</span>
        </div>
      {% else %}
        <div class="notice mb-12">
          <div>
            <b>PAPER mode.</b> Safe-by-default: no real orders. Start here, then DRY-RUN, then LIVE (small).
          </div>
          <span class="badge">paper</span>
        </div>
      {% endif %}

      {# Noob-friendly critical warnings (skip in paper mode ‚Äî no real gas data) #}
      {% if display_mode != 'paper' and snap and (snap.get('native_gas_balance', 0) < (native_gas_min|default(0.15))) %}
        <div class="notice warn mb-12">
          <div>
            <b>Low gas warning.</b>
            This wallet is low on <span class="mono">{{ snap.get('native_gas_symbol','POL') }}</span>.
            Redeems/withdrawals may fail until you top it up.
            <span class="muted">Quick fix: send ~$1‚Äì$3 worth of {{ snap.get('native_gas_symbol','POL') }} (POL/MATIC) to your bot wallet{% if wallet_address %}: <span class="mono" style="font-size:0.8rem;word-break:break-all;">{{ wallet_address }}</span>{% endif %}.</span>
            <span class="muted">Optional: see ‚ÄúHow It Works‚Äù ‚Üí Advanced ‚Üí Top up gas.</span>
          </div>
          <span class="badge">gas</span>
        </div>
      {% endif %}

      <!-- Tab bar ‚Äî 3 tabs -->
      <div class="tab-bar">
        <button class="tab-btn active" data-tab="tab-signal">Signal &amp; Trading</button>
        <button class="tab-btn" data-tab="tab-trades">Trades &amp; Equity</button>
        <button class="tab-btn" data-tab="tab-ops">Ops Events</button>
        <button class="tab-btn" data-tab="tab-terminal">Terminal</button>
        <button class="tab-btn" data-tab="tab-help">How It Works</button>
      </div>

      <!-- ============================================================
           TAB 1 ‚Äî SIGNAL & LIVE TRADING (merged)
           ============================================================ -->
      <div class="tab-panel active" id="tab-signal">

        {# ‚îÄ‚îÄ Signal + BTC Chart side-by-side ‚îÄ‚îÄ #}
        <div class="grid-2">
          {# LEFT: Signal Card #}
          <div class="card">
            <div class="hd">
              <h2>Signal</h2>
              <span class="hd-badge">
                <span class="live-dot {% if state and state.get('status') == 'ok' %}on{% else %}off{% endif %}"></span>
                auto-refresh
              </span>
            </div>
            <div class="bd" hx-get="/p/state" hx-trigger="load, every 5s" hx-swap="innerHTML">
              {% include "partials/state.html" %}
            </div>
          </div>

          {# RIGHT: Live BTC Chart #}
          <div class="card">
            <div class="hd">
              <h2>BTC-USD</h2>
              <span class="hd-badge mono" id="btcSpotBadge">$--</span>
            </div>
            <div class="bd">
              <div class="chartBox h240">
                <canvas id="btcLiveChart"></canvas>
              </div>
              <div class="small mt-12 flex-between">
                <span>Live spot price &middot; every 10s</span>
                <span class="mono fs-11" id="btcPriceChange">--</span>
              </div>
            </div>
          </div>
        </div>

        <script>
        (function(){
          if(window.__btcChartInit) return;
          window.__btcChartInit = true;
          var el = document.getElementById('btcLiveChart');
          if(!el || !window.Chart) return;
          var ctx = el.getContext('2d');
          var prices = [], labels = [], MAX = 120;
          var gradient = ctx.createLinearGradient(0, 0, 0, 240);
          gradient.addColorStop(0, 'rgba(247,215,116,0.18)');
          gradient.addColorStop(1, 'rgba(247,215,116,0)');
          var chart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: [{
              data: prices,
              borderColor: 'rgba(247,215,116,0.9)',
              backgroundColor: gradient,
              tension: 0.3, pointRadius: 0, fill: true, borderWidth: 1.5
            }]},
            options: {
              responsive: true, maintainAspectRatio: false, animation: false,
              plugins: { legend: { display: false },
                tooltip: { mode:'index', intersect:false,
                  callbacks: { label: function(c){ return '$'+Number(c.raw).toLocaleString(undefined,{minimumFractionDigits:2}); }}
                }
              },
              scales: {
                x: { ticks: { color:'rgba(255,255,255,0.3)', font:{size:9}, maxTicksLimit:8 }, grid: { color:'rgba(255,255,255,0.04)' }},
                y: { ticks: { color:'rgba(255,255,255,0.4)', font:{size:10},
                       callback: function(v){ return '$'+Number(v).toLocaleString(); }
                     }, grid: { color:'rgba(255,255,255,0.05)' }}
              }
            }
          });
          var badge = document.getElementById('btcSpotBadge');
          var change = document.getElementById('btcPriceChange');
          var firstPrice = null;
          function refresh(){
            fetch('/api/btc/price',{credentials:'same-origin'})
              .then(function(r){ return r.ok ? r.json() : null; })
              .then(function(d){
                if(!d || !d.price) return;
                var p = d.price;
                var now = new Date();
                var t = now.toTimeString().slice(0,8);
                prices.push(p); labels.push(t);
                if(prices.length > MAX){ prices.shift(); labels.shift(); }
                chart.update();
                if(badge) badge.textContent = '$'+Number(p).toLocaleString(undefined,{minimumFractionDigits:2});
                // update inline spot price in state partial too
                var inline = document.getElementById('liveSpotPrice');
                if(inline) inline.textContent = '$'+Number(p).toLocaleString(undefined,{minimumFractionDigits:2});
                // show change since start
                if(firstPrice===null) firstPrice = p;
                if(change){
                  var diff = p - firstPrice;
                  var pct = firstPrice ? ((diff/firstPrice)*100).toFixed(2) : '0.00';
                  var sign = diff >= 0 ? '+' : '';
                  change.textContent = sign+'$'+diff.toFixed(2)+' ('+sign+pct+'%)';
                  change.style.color = diff >= 0 ? 'var(--mint)' : 'var(--red)';
                }
              }).catch(function(){});
          }
          refresh();
          setInterval(refresh, 10000);
        })();
        </script>

        <div class="section-divider">live status</div>

        {# ‚îÄ‚îÄ Live Trading Card ‚îÄ‚îÄ #}
        <div class="card dual-section">
          <div class="hd">
            <h2>Live Trading</h2>
            <span class="hd-badge">
              {% if dm == 'live' %}
                <span class="live-dot on"></span> polymarket
              {% elif dm == 'dry' %}
                <span class="live-dot off"></span> dry-run
              {% else %}
                <span class="live-dot off"></span> paper
              {% endif %}
            </span>
          </div>
          <div class="bd">
        <div id="liveStatus" hx-get="/p/live" hx-trigger="load, every 5s" hx-swap="innerHTML show:no-scroll" class="htmx-fade-swap">
              <div class="small">Loading live status&hellip;</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ============================================================
           TAB 2 ‚Äî TRADES & EQUITY (merged)
           ============================================================ -->
      <div class="tab-panel" id="tab-trades">

        {# ‚îÄ‚îÄ Stats Summary + Reset ‚îÄ‚îÄ #}
        <div class="flex-between mb-12">
          <span class="small mono ls-03">TRADE HISTORY + PERFORMANCE</span>
          <form class="inline" method="post" action="/reset/stats" onsubmit="return confirm('Reset all trade stats and equity history? This cannot be undone.');">
            <button type="submit" class="btn-danger-sm">Reset Stats</button>
          </form>
        </div>

        {# ‚îÄ‚îÄ Recent Trades Card ‚îÄ‚îÄ #}
        <div class="card dual-section">
          <div class="hd">
            <h2>Recent Trades</h2>
            <span class="hd-badge">history</span>
          </div>
          <div class="bd" hx-get="/p/trades" hx-trigger="load, every 5s" hx-swap="innerHTML">
            <div class="small">Loading trades&hellip;</div>
          </div>
        </div>

        <div class="section-divider">equity curve</div>

        {# ‚îÄ‚îÄ Equity Chart Card ‚îÄ‚îÄ #}
        <div class="card dual-section">
          <div class="hd">
            <h2>Equity Curve</h2>
            <span class="hd-badge">USDC</span>
          </div>
          <div class="bd">
            <div class="chartBox h300">
              <canvas id="equityChart"></canvas>
            </div>
            <div class="small mt-12">
              Your total account equity over time. Updates every 30 seconds.
            </div>
          </div>
        </div>

        <script>
          (function () {
            if (window.__equityChartInit) return;
            window.__equityChartInit = true;

            var el = document.getElementById('equityChart');
            if (!el || !window.Chart) return;

            var ctx = el.getContext('2d');
            var data = {
              labels: [],
              datasets: [
                {
                  label: 'Total equity (USDC)',
                  data: [],
                  borderColor: 'rgba(104,246,199,0.85)',
                  backgroundColor: 'rgba(104,246,199,0.08)',
                  tension: 0.3,
                  pointRadius: 0,
                  fill: true,
                  borderWidth: 1.5,
                }
              ]
            };

            var chart = new Chart(ctx, {
              type: 'line',
              data: data,
              options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                  legend: { display: false },
                  tooltip: { mode: 'index', intersect: false },
                },
                scales: {
                  x: {
                    ticks: { color: 'rgba(255,255,255,0.35)', font: { size: 9 }, maxTicksLimit: 12 },
                    grid: { color: 'rgba(255,255,255,0.04)' },
                  },
                  y: {
                    ticks: { color: 'rgba(255,255,255,0.45)', font: { size: 10 } },
                    grid: { color: 'rgba(255,255,255,0.05)' },
                  }
                }
              }
            });
            window.__equityChart = chart;

            function refresh() {
              fetch('/api/poly/equity', { credentials: 'same-origin' })
                .then(function(r){ return r.ok ? r.json() : []; })
                .then(function(series){
                  if (!Array.isArray(series) || series.length === 0) return;
                  var last = series.slice(-600);
                  chart.data.labels = last.map(function(p){
                    var d = new Date((p.ts || 0) * 1000);
                    // Local time-of-day; keep compact for chart.
                    var hh = String(d.getHours()).padStart(2, '0');
                    var mm = String(d.getMinutes()).padStart(2, '0');
                    var ss = String(d.getSeconds()).padStart(2, '0');
                    return hh + ':' + mm + ':' + ss;
                  });
                  chart.data.datasets[0].data = last.map(function(p){ return Number(p.equity || 0); });
                  chart.update();
                })
                .catch(function(){});
            }

            refresh();
            setInterval(refresh, 30000);
          })();
        </script>
      </div>

      <!-- ============================================================
           TAB 3 ‚Äî OPS & LOGS
           ============================================================ -->
      <div class="tab-panel" id="tab-ops">
        <div hx-get="/p/ops" hx-trigger="load, every 5s" hx-swap="innerHTML show:no-scroll" class="htmx-fade-swap">
          <div class="card">
            <div class="bd muted">Loading ops &amp; logs&hellip;</div>
          </div>
        </div>
      </div>

      <!-- ============================================================
           TAB 4 ‚Äî TERMINAL (SSE live log stream)
           ============================================================ -->
      <div class="tab-panel" id="tab-terminal">
        <div class="card">
          <div class="hd">
            <h2>Terminal</h2>
            <div class="hd-badge mono" id="term-badge" style="transition:color 0.3s;">connecting&hellip;</div>
          </div>
          <div class="bd">
            <div class="small mb-10">
              Live stream of <span class="mono">logs/app.log</span>.
              Lines appear as they are written &mdash; no page refresh needed.
              Use for debugging errors and stack traces.
            </div>
            <pre id="term-out" class="codebox" style="max-height:500px;overflow-y:auto;white-space:pre-wrap;word-break:break-all;"></pre>
            <div class="small mt-8" style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
              <span id="term-linecount" class="muted mono">0 lines</span>
              <button class="btn-sm" onclick="(function(){var el=document.getElementById('term-out');if(el)el.scrollTop=el.scrollHeight;})();" style="cursor:pointer;">&#8595; Jump to bottom</button>
            </div>
          </div>
        </div>

        <script>
        (function(){
          var out       = document.getElementById('term-out');
          var badge     = document.getElementById('term-badge');
          var linecount = document.getElementById('term-linecount');
          var MAX_LINES = 600;
          var linesBuf  = [];
          var es        = null;
          var connected = false;

          function setBadge(text, color) {
            if (!badge) return;
            badge.textContent = text;
            badge.style.color = color || '';
          }

          function updateCount() {
            if (linecount) linecount.textContent = linesBuf.length + ' lines';
          }

          /* Append a single line, preserving scroll position unless the user
             was already at (or very near) the bottom. */
          function appendLine(text) {
            if (!out) return;
            var atBottom = (out.scrollHeight - out.scrollTop - out.clientHeight) < 80;

            if (linesBuf.length >= MAX_LINES) {
              /* Buffer full: shift oldest, do a full replace (trim). */
              linesBuf.shift();
              linesBuf.push(text);
              var savedTop = out.scrollTop;
              out.textContent = linesBuf.join('\n');
              out.scrollTop = atBottom ? out.scrollHeight : savedTop;
            } else {
              /* Buffer has room: true DOM append ‚Äî zero scroll disruption. */
              linesBuf.push(text);
              out.textContent += (out.textContent ? '\n' : '') + text;
              if (atBottom) out.scrollTop = out.scrollHeight;
            }
            updateCount();
          }

          function connect() {
            if (es) { try { es.close(); } catch(e){} es = null; }
            setBadge('connecting\u2026', 'var(--muted,#888)');

            es = new EventSource('/p/terminal/stream', { withCredentials: true });

            /* Initial dump: server sends last 200 lines as one 'init' event.
               e.data contains all lines joined by \n. */
            es.addEventListener('init', function(e) {
              var lines = (e.data || '').split('\n').filter(Boolean);
              linesBuf = lines.slice(-MAX_LINES);
              if (out) {
                out.textContent = linesBuf.join('\n');
                out.scrollTop   = out.scrollHeight;   /* Scroll to bottom on first load */
              }
              updateCount();
              setBadge('\u25cf live', 'var(--mint,#68f6c7)');
              connected = true;
            });

            /* Subsequent lines arrive one at a time as standard 'message' events. */
            es.onmessage = function(e) {
              if (e.data) appendLine(e.data);
            };

            es.onopen = function() {
              if (!connected) setBadge('\u25cf live', 'var(--mint,#68f6c7)');
            };

            es.onerror = function() {
              connected = false;
              setBadge('\u21bb reconnecting', 'var(--yellow,#f7d774)');
              /* EventSource auto-reconnects after ~3 s per spec. */
            };
          }

          /* Lazy connect: only open the SSE stream when the user first clicks
             the Terminal tab (saves a persistent connection when unused). */
          var tabBtn = document.querySelector('[data-tab="tab-terminal"]');
          if (tabBtn) {
            tabBtn.addEventListener('click', function() {
              if (!es) connect();
            });
          }

          /* If the terminal panel is somehow already active on page load, connect now. */
          var panel = document.getElementById('tab-terminal');
          if (panel && panel.classList.contains('active') && !es) connect();

        })();
        </script>
      </div>

      <!-- ============================================================
           TAB 5 ‚Äî HOW IT WORKS (comprehensive noob-friendly guide)
           ============================================================ -->
      <div class="tab-panel" id="tab-help">

        {# ‚îÄ‚îÄ Getting Started ‚îÄ‚îÄ #}
        <div class="card dual-section">
          <div class="hd">
            <h2>Getting Started</h2>
            <span class="hd-badge">step-by-step</span>
          </div>
          <div class="bd">
            <div class="small mb-10">
              This bot predicts whether <b>BTC will go up or down</b> in the next 5 minutes and can optionally
              place trades on <b>Polymarket</b> if you enable execution. It uses the <b>Chainlink oracle</b> (the same
              price source Polymarket uses to resolve markets) and has built-in <b>risk rails</b> to protect your capital.
              Start in paper mode first.
            </div>

            <div class="step-cards">
              <div class="step-card">
                <div class="step-num">1</div>
                <div class="step-body">
                  <div class="step-title">Start in Paper mode</div>
                  <div class="step-desc">
                    The bot begins in <b>PAPER</b> mode by default. It makes predictions but does <em>not</em> trade real money.
                    Watch the Signal card for a few hours to see how it performs. No wallet or funds needed.
                  </div>
                </div>
              </div>
              <div class="step-card">
                <div class="step-num">2</div>
                <div class="step-body">
                  <div class="step-title">Understand the Signal</div>
                  <div class="step-desc">
                    The model outputs <b>UP</b> or <b>DOWN</b> with a <b>confidence score</b> (0.50&ndash;1.00).
                    On this dashboard the Signal card auto-refreshes and usually updates about every <b>~15 seconds</b> between retrains.
                    Higher confidence = stronger conviction. If it's below the threshold you set in the sidebar, no trade is placed.
                  </div>
                </div>
              </div>
              <div class="step-card">
                <div class="step-num">3</div>
                <div class="step-body">
                  <div class="step-title">Try Dry-Run mode</div>
                  <div class="step-desc">
                    Switch to <b>DRY-RUN</b> in the sidebar. The bot now finds real Polymarket markets and simulates trades,
                    but <em>never spends money</em>. This lets you verify the full pipeline works with your wallet.
                  </div>
                </div>
              </div>
              <div class="step-card">
                <div class="step-num">4</div>
                <div class="step-body">
                  <div class="step-title">Go Live (small)</div>
                  <div class="step-desc">
                    Set a small <b>max $ per trade</b> ($2&ndash;5). Switch to <b>LIVE</b>. The bot will place real trades
                    on Polymarket using your connected wallet. Start small and scale up as you gain trust.
                  </div>
                </div>
              </div>
              <div class="step-card">
                <div class="step-num">5</div>
                <div class="step-body">
                  <div class="step-title">Monitor &amp; Withdraw</div>
                  <div class="step-desc">
                    Check the <b>Trades &amp; Equity</b> tab to track wins/losses and your equity curve.
                    When you want to take profits, use the <b>Withdraw</b> section in Advanced below.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {# ‚îÄ‚îÄ Dashboard Legend ‚îÄ‚îÄ #}
        <div class="card dual-section">
          <div class="hd">
            <h2>Dashboard Legend</h2>
            <span class="hd-badge">what everything means</span>
          </div>
          <div class="bd">
            <div class="small mb-10">Here's what every icon, badge, and number on the dashboard means.</div>

            <div class="legend-grid">
              <div class="legend-item">
                <div class="legend-icon">&#8593;</div>
                <div class="legend-text">
                  <div class="legend-term up">UP Signal</div>
                  <div class="legend-def">The model predicts BTC price will be <b>higher</b> in 5 minutes.</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon">&#8595;</div>
                <div class="legend-text">
                  <div class="legend-term down">DOWN Signal</div>
                  <div class="legend-def">The model predicts BTC price will be <b>lower</b> in 5 minutes.</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon gold">0.72</div>
                <div class="legend-text">
                  <div class="legend-term">Confidence</div>
                  <div class="legend-def">How sure the model is (0.50 = coin flip, 1.00 = 100% sure). Only trades above your <b>threshold</b> get placed.</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon"><span class="live-dot on mr-0"></span></div>
                <div class="legend-text">
                  <div class="legend-term">Green Dot</div>
                  <div class="legend-def">Bot is running and connected. Data is refreshing automatically.</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon">&#9203;</div>
                <div class="legend-text">
                  <div class="legend-term gold">Training</div>
                  <div class="legend-def">The model is retraining on fresh data. Happens every hour. Signal pauses briefly.</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon fs-14"><span class="tag live tag-sm tag-xs">live</span></div>
                <div class="legend-text">
                  <div class="legend-term">Live Badge</div>
                  <div class="legend-def">Trade was placed with <b>real money</b> on Polymarket.</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon fs-14"><span class="tag warn tag-sm tag-xs">dry</span></div>
                <div class="legend-text">
                  <div class="legend-term">Dry Badge</div>
                  <div class="legend-def">Simulated trade &mdash; <b>no real money</b> was spent. Used in paper/dry-run modes.</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon up">W</div>
                <div class="legend-text">
                  <div class="legend-term up">Win</div>
                  <div class="legend-def">Your prediction was correct. The market resolved in your favor.</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon down">L</div>
                <div class="legend-text">
                  <div class="legend-term down">Loss</div>
                  <div class="legend-def">Your prediction was wrong. The market resolved against you.</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon muted">&hellip;</div>
                <div class="legend-text">
                  <div class="legend-term">Pending</div>
                  <div class="legend-def">Trade placed but market hasn't resolved yet. Wait ~5&ndash;10 minutes.</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon">&#128200;</div>
                <div class="legend-text">
                  <div class="legend-term gold">Equity Curve</div>
                  <div class="legend-def">A chart of your total account value over time. Going up = making money.</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon fs-14 mono">$</div>
                <div class="legend-text">
                  <div class="legend-term">USDC</div>
                  <div class="legend-def">USD Coin &mdash; a cryptocurrency pegged 1:1 to the US Dollar. $5 USDC = $5 USD.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {# ‚îÄ‚îÄ Sidebar Settings Explained ‚îÄ‚îÄ #}
        <div class="card dual-section">
          <div class="hd">
            <h2>Settings Explained</h2>
            <span class="hd-badge">sidebar reference</span>
          </div>
          <div class="bd">
            <div class="legend-grid">
              <div class="legend-item">
                <div class="legend-icon">&#9881;</div>
                <div class="legend-text">
                  <div class="legend-term">Auto-trade</div>
                  <div class="legend-def">When <b>ON</b>, the bot automatically places trades. When OFF, it only shows predictions. Turn this on when you're ready.</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon">&#128171;</div>
                <div class="legend-text">
                  <div class="legend-term">Dry-run</div>
                  <div class="legend-def">Simulates trades without spending money. Perfect for testing your settings before going live.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#9889;</div>
                <div class="legend-text">
                  <div class="legend-term">High-risk</div>
                  <div class="legend-def">Unlocks higher % sizing caps. Default Bet % cap is <b>10%</b>. High-risk raises it to <b>50%</b>. Dangerous.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#9760;</div>
                <div class="legend-text">
                  <div class="legend-term danger">Expert/UNSAFE</div>
                  <div class="legend-def">Full control mode. Requires typing <b>I UNDERSTAND</b> once to enable. Raises Bet % cap to <b>100%</b>. Extremely dangerous.</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon">&#128176;</div>
                <div class="legend-text">
                  <div class="legend-term">Max $ / trade</div>
                  <div class="legend-def">Safety cap. The bot will <b>never</b> bet more than this per trade. Start with $2&ndash;5.</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon">&#128202;</div>
                <div class="legend-text">
                  <div class="legend-term">Bet Mode</div>
                  <div class="legend-def"><b>Fixed $</b> = same amount every trade. <b>% of bal</b> = a percentage of your current wallet balance (auto-scales).</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#127919;</div>
                <div class="legend-text">
                  <div class="legend-term">Bet %</div>
                  <div class="legend-def">Used only when Bet Mode = <b>% of bal</b>. Capped by risk mode: <b>10%</b> (default), <b>50%</b> (High-risk), <b>100%</b> (Expert/UNSAFE).</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon">&#127919;</div>
                <div class="legend-text">
                  <div class="legend-term">Confidence Threshold</div>
                  <div class="legend-def">Minimum confidence to place a trade. <b>0.55</b> means "only trade when the model is at least 55% sure." Higher = fewer but safer trades.</div>
                </div>
              </div>
              <div class="legend-item">
                <div class="legend-icon">&#128260;</div>
                <div class="legend-text">
                  <div class="legend-term">Paper / Dry / Live</div>
                  <div class="legend-def"><b>Paper</b> = predictions only. <b>Dry</b> = simulated trades. <b>Live</b> = real money on Polymarket. Always start on Paper.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#127919;</div>
                <div class="legend-text">
                  <div class="legend-term">Snipe Mode</div>
                  <div class="legend-def">Late-entry strategy. Near the end of each 5-minute window, checks if BTC already moved via Chainlink oracle. Higher accuracy (~80-90%+). In <b>delta-first mode</b> (default since v0.5.0), this is the <b>primary and only</b> entry mechanism ‚Äî ML trades are disabled.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#9878;</div>
                <div class="legend-text">
                  <div class="legend-term">Arb-first</div>
                  <div class="legend-def">Buys <b>both</b> UP + DOWN only when the orderbook makes the combined cost less than $1.00. Locks in profit regardless of outcome. Rare but high-confidence.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#128176;</div>
                <div class="legend-text">
                  <div class="legend-term">Auto-redeem</div>
                  <div class="legend-def">After a market resolves as a <b>win</b>, auto-redeem sends an on-chain transaction (Polygon) to claim your winnings. Costs a tiny amount of gas. <b>ON by default</b>.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#128200;</div>
                <div class="legend-text">
                  <div class="legend-term">Kelly fraction</div>
                  <div class="legend-def">Controls bet sizing when using Kelly mode. <b>0.25</b> (1/4 Kelly) is the safe default. Higher = more aggressive. Only matters when Bet Mode = Kelly.</div>
                </div>
              </div>

              {# ‚îÄ‚îÄ v0.3.0 settings ‚îÄ‚îÄ #}
              <div class="legend-item">
                <div class="legend-icon">&#128640;</div>
                <div class="legend-text">
                  <div class="legend-term">Snipe Bet Multiplier</div>
                  <div class="legend-def">Multiplies your normal bet size for <b>snipe trades only</b> (default <b>2&times;</b>). Because snipe accuracy is much higher, it makes sense to bet more on those trades. Still capped by your Max&nbsp;$/trade safety limit.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#9889;</div>
                <div class="legend-text">
                  <div class="legend-term">Delta-First Mode</div>
                  <div class="legend-def"><b>v0.5.0 (default ON)</b>. Disables ML-only directional trades. The snipe pass at T-10s using live Chainlink delta becomes the sole entry mechanism. The ML model still trains and shows predictions on the dashboard, but doesn't trigger trades. Set <code>C5_DELTA_FIRST=false</code> to restore ML+snipe hybrid.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#128178;</div>
                <div class="legend-text">
                  <div class="legend-term">Delta Pricing</div>
                  <div class="legend-def"><b>v0.5.0 (default ON)</b>. Gates snipe trades based on the live ask vs. the delta magnitude. If the market asks more than the tier allows, the trade is skipped (too expensive). Small delta &rarr; cheap gate ($0.52). Large delta &rarr; permissive gate ($0.97). Tiers tunable via <code>C5_DELTA_PRICE_T1</code>&ndash;<code>T5</code>.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#9201;</div>
                <div class="legend-text">
                  <div class="legend-term">Trade Lead (seconds)</div>
                  <div class="legend-def">How many seconds before a window closes to place the trade. Default <b>10</b>. Lower values = more accurate direction reading, but less time for the order to fill. Applies to <b>snipe mode</b>.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#9202;</div>
                <div class="legend-text">
                  <div class="legend-term">Cooldown (seconds)</div>
                  <div class="legend-def">Minimum wait time between trades. Default <b>300</b> (5 minutes = 1 window). Prevents overtrading. Set to <b>0</b> to disable (trade every window).</div>
                </div>
              </div>

              {# ‚îÄ‚îÄ v0.4.0 settings ‚îÄ‚îÄ #}
              <div class="legend-item">
                <div class="legend-icon">&#129504;</div>
                <div class="legend-text">
                  <div class="legend-term">Ensemble Weight</div>
                  <div class="legend-def">How much the final prediction leans on the <b>ML model vs. live Chainlink price movement</b>. Default <b>0.6</b> = 60% model + 40% Chainlink delta. Raise to <b>0.8+</b> to rely more on the trained model; lower to <b>0.4</b> to lean more on real-time price momentum. Range: 0.0&ndash;1.0.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#127769;</div>
                <div class="legend-text">
                  <div class="legend-term">Quiet Hours (UTC)</div>
                  <div class="legend-def">Comma-separated UTC hours when the bot <b>skips ML trades</b> (e.g. <code>3,4,5</code> = 3:00&ndash;5:59 AM UTC). Useful for low-liquidity periods. Snipe trades are <b>never</b> blocked by quiet hours. Leave blank to disable.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#128200;</div>
                <div class="legend-text">
                  <div class="legend-term">Platt Calibration <span class="lozenge mint">auto</span></div>
                  <div class="legend-def">The model's raw probability outputs are automatically <b>calibrated</b> so that when it says &ldquo;60%&rdquo; it really means 60%. This uses Isotonic Regression on a held-out validation set. No setting to adjust &mdash; it&rsquo;s always on when enough data exists (30+ training samples).</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#128279;</div>
                <div class="legend-text">
                  <div class="legend-term">Hybrid Training Target <span class="lozenge mint">auto</span></div>
                  <div class="legend-def">When the bot has collected enough <b>Chainlink price history</b> (10+ data points), it trains on Chainlink price changes instead of Coinbase. This fixes the <b>oracle mismatch</b> &mdash; the model now learns from the same price feed that decides winners. Activates automatically as data accumulates.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#128737;</div>
                <div class="legend-text">
                  <div class="legend-term">Edge Gate (Min Edge)</div>
                  <div class="legend-def">Filter for ML trades. Only trades when the model's edge <b>(p &minus; market price)</b> exceeds this value. Default <b>0.03</b>. Set to <b>0.02&ndash;0.05</b> for conservative trading. Set to <b>0</b> to disable. <b>Snipe trades bypass this</b> &mdash; they use their own delta threshold.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#128721;</div>
                <div class="legend-text">
                  <div class="legend-term danger">Risk Rails</div>
                  <div class="legend-def">Automated safety limits (circuit breakers) that <b>pause trading</b> when things go wrong. Protects your capital while you're away. All values adjustable in the sidebar under <b>Risk Rails</b>. Set any to <b>0</b> to disable that rail.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#128200;</div>
                <div class="legend-text">
                  <div class="legend-term">Daily Loss Limit %</div>
                  <div class="legend-def">Pauses trading after losing this much of your balance in any 24-hour window. Default <b>10%</b>. Prevents runaway losses on bad days.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#128683;</div>
                <div class="legend-text">
                  <div class="legend-term">Consecutive Loss Limit</div>
                  <div class="legend-def">Pauses trading after this many <b>losing trades in a row</b>. Default <b>5</b>. A streak of losses may signal bad market conditions &mdash; better to pause.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#128683;</div>
                <div class="legend-text">
                  <div class="legend-term">Unfilled Ratio</div>
                  <div class="legend-def">Pauses if more than this fraction of your recent orders went <b>unfilled</b>. Default <b>0.5</b> (50%). High unfilled rates waste gas and signal thin liquidity.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#128270;</div>
                <div class="legend-text">
                  <div class="legend-term">Unfilled Lookback</div>
                  <div class="legend-def">How many recent orders to check for the unfilled-ratio calculation. Default <b>20</b>. Smaller values react faster; larger values are more stable.</div>
                </div>
              </div>

              <div class="legend-item">
                <div class="legend-icon">&#9200;</div>
                <div class="legend-text">
                  <div class="legend-term">Auto-Resume (minutes)</div>
                  <div class="legend-def">If risk rails pause trading, it automatically resumes after this many minutes. Default <b>60</b>. Set to <b>0</b> for manual-only resume (you must unpause from the dashboard).</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {# ‚îÄ‚îÄ FAQ ‚îÄ‚îÄ #}
        <div class="card dual-section">
          <div class="hd">
            <h2>FAQ</h2>
            <span class="hd-badge">common questions</span>
          </div>
          <div class="bd">
            <details class="faq-item">
              <summary class="faq-q">How does the bot actually predict?</summary>
              <div class="faq-a">
                It uses a <b>CNN-LSTM</b> neural network (convolutional + recurrent) with a LightGBM/LogisticRegression fallback.
                It analyzes <b>42+ technical indicators</b> from recent BTC candles including
                RSI, MACD, Bollinger Bands, stochastics, volume ratios, ADX, OBV, volatility regime, multi-timeframe returns, and time-of-day patterns.
                The model retrains every hour on fresh data to stay current.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What is Polymarket?</summary>
              <div class="faq-a">
                <b>Polymarket</b> is a prediction market platform where you can bet on real-world outcomes.
                This bot trades "BTC Up or Down in 5 minutes" markets. You buy <b>Yes</b> or <b>No</b> shares using USDC,
                and if you're right, each share pays out $1. If you're wrong, you lose your bet.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">How much money do I need to start?</summary>
              <div class="faq-a">
                You can start with as little as <b>$10&ndash;20 USDC</b>. Set your max per trade to $2&ndash;5.
                The bot trades small amounts frequently. You don't need a big bankroll to test it out.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">Can I lose money?</summary>
              <div class="faq-a">
                <b>Yes.</b> This is real trading. The model is not always right &mdash; a 55&ndash;60% win rate is typical.
                You will have losing trades. The edge comes from trading <em>many</em> small bets where wins slightly outnumber losses.
                <b>Never bet more than you can afford to lose.</b>
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What's a "window"?</summary>
              <div class="faq-a">
                A <b>window</b> is a 5-minute time block (e.g. 14:05&ndash;14:10 UTC). Each window has its own Polymarket market.
                The bot places one trade per window. The countdown in "Live Trading" shows how much time is left in the current window.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">Why does it say "Training" sometimes?</summary>
              <div class="faq-a">
                Every hour, the model <b>retrains</b> on the latest BTC price data (last ~8,600 candles / 30 days). This takes 30&ndash;90 seconds.
                During training, the signal pauses briefly. This is normal and ensures the model stays current.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What if the signal shows low confidence?</summary>
              <div class="faq-a">
                If confidence is below your <b>threshold</b> (set in the sidebar), the bot <b>skips</b> that window.
                No trade is placed. This is a safety feature &mdash; it only trades when it's reasonably confident.
                You'll see "skipped" in the trade log for those windows.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">How do I know if it's actually working?</summary>
              <div class="faq-a">
                Check the <b>Signal</b> card &mdash; the price and direction should update frequently (usually every <b>~15 seconds</b> between retrains).
                The "updated X ago" timestamp tells you when the last prediction was generated.
                In the <b>Trades</b> tab, you'll see logged trades with results (W/L/pending).
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">Why does Bet % clamp to 10% / 50% / 100%?</summary>
              <div class="faq-a">
                This is a safety rail to prevent accidental account blow-ups.
                By default, Bet % is capped at <b>10%</b>. Enabling <b>High-risk</b> raises the cap to <b>50%</b>.
                Enabling <b>Expert/UNSAFE</b> (typed confirmation) raises the cap to <b>100%</b>.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">Signal says UP/DOWN, but why did it place a different trade?</summary>
              <div class="faq-a">
                The Signal shows the model's <b>current opinion</b>. Trades are only attempted during the specific 5-minute window's trade time.
                If a trade was placed, the Signal card also shows <b>Polymarket: order placed</b> and the trade direction for that window.
                If the market wasn't available yet, confidence was below your threshold, or you were paused, it may show <b>skipped</b>.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What does "Reset Stats" do?</summary>
              <div class="faq-a">
                It clears all trade history, win/loss stats, and the equity chart. Useful if you've been testing and want a fresh start.
                <b>This does not affect your wallet balance</b> &mdash; it only resets the dashboard's records.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">How do I withdraw profits?</summary>
              <div class="faq-a">
                Go to the <b>Advanced</b> section below. Enter the amount in USDC you want to withdraw, type "I understand" in the
                confirmation field, and submit. USDC will be sent from your trading wallet to your personal wallet address (set during setup).
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">Why is the signal taking so long to load / showing "---" for a while?</summary>
              <div class="faq-a">
                The bot retrains its ML model <b>every hour</b> on fresh price data. With 4 symbols active (BTC/ETH/SOL/XRP),
                training takes approximately <b>2 minutes per symbol ‚Äî up to ~8 minutes total</b>. During this time the Signal card
                shows "training" or stale data. This is completely normal ‚Äî the signal resumes automatically when training finishes.
                <br><br>
                <b>v0.6.7+:</b> Before this update, training time was also causing the watchdog timer to fire and restart the bot
                every ~8 minutes (the restart loop bug). That's now fixed ‚Äî training completes cleanly without interruption.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">Why are my wins so small? I'm winning but barely making any profit.</summary>
              <div class="faq-a">
                This is expected with <b>Snipe mode</b> (the default). Snipe fires at T-10 seconds ‚Äî when BTC has <em>already</em> clearly moved.
                At that point Polymarket prices the shares at <b>$0.70‚Äì$0.95</b> because the market already "knows" which direction it's going.
                Your payout is always $1.00/share, so profit per share is only <b>$0.05‚Äì$0.30</b>.
                <br><br>
                The trade-off: accuracy is ~80‚Äì90%+. Small margins on many trades still compound.
                <br><br>
                <b>To improve margins:</b>
                <ul>
                  <li><b>Turn off Delta Pricing</b> (sidebar ‚Üí Trading ‚Üí Delta Pricing ‚Üí Save) ‚Äî relaxes the ask gate, allows trades at cheaper prices with weaker signals</li>
                  <li><b>Turn off Delta-First mode</b> (sidebar ‚Üí Trading ‚Üí Delta-First ‚Üí Save) ‚Äî re-enables ML trades which enter at ~$0.50/share (bigger margin per share, but ~52‚Äì55% accuracy)</li>
                  <li><b>Increase bet size</b> gradually after you trust the win rate</li>
                </ul>
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">How do I get more trades? The bot only fires a few times per hour.</summary>
              <div class="faq-a">
                With <b>Delta-First mode ON</b> (default), the bot only enters via the late T-10s snipe ‚Äî and only when BTC moves enough
                to clear the delta threshold. Not every 5-minute window qualifies, so some windows are skipped.
                <br><br>
                <b>To get more trades:</b>
                <ul>
                  <li><b>Turn off Delta-First mode</b> (sidebar ‚Üí Trading ‚Üí Delta-First ‚Üí Save) ‚Äî restores ML directional trades as a second entry path alongside snipe. Expect 2‚Äì4√ó more trades, but lower average win rate (~55% vs ~85%).</li>
                  <li><b>Lower confidence threshold</b> (sidebar ‚Üí Signal ‚Üí Threshold ‚Üí try 0.50 or 0.52)</li>
                  <li><b>Turn off Delta Pricing</b> ‚Äî relaxes the ask price gate that blocks some snipe entries</li>
                </ul>
                <b>Caution:</b> More trades = more exposure. Always experiment with small bet sizes first.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What's the difference between Fixed $ and % of balance?</summary>
              <div class="faq-a">
                <b>Fixed $</b>: Every trade is the exact same amount (e.g. $5). Simple and predictable.<br>
                <b>% of bal</b>: Each trade is a percentage of your current wallet balance (e.g. 5% of $100 = $5).
                As you win, bets grow. As you lose, bets shrink. This is sometimes called "Kelly-style" sizing.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What is Kelly (fractional) bet sizing?</summary>
              <div class="faq-a">
                <b>Kelly sizing</b> increases (or decreases) your bet size based on your estimated edge.
                In this product, we use a simplified prediction-market version:
                if your model probability is $p$ and the market price is $P$, then full Kelly is:
                <span class="mono">F = (p - P) / (1 - P)</span> (only when <span class="mono">p &gt; P</span>).
                <br><br>
                Because the model can be wrong, we use <b>fractional Kelly</b>:
                we multiply by <b>Kelly fraction</b> (default <b>0.25 = 1/4 Kelly</b>).
                This is a practical risk control, not a profit guarantee.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">Is my wallet key safe?</summary>
              <div class="faq-a">
                Your private key is stored <b>only on your server</b> in the config folder. It never leaves
                the machine. The bot uses it to sign Polymarket transactions. If you're running this on a remote
                server, make sure it's secured (firewall, SSH keys, strong password).
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What is Snipe mode?</summary>
              <div class="faq-a">
                Snipe mode is a <b>separate, optional</b> trading strategy. Instead of predicting direction before the
                5-minute window starts, snipe waits until the <b>last ~10 seconds</b> and checks whether BTC has
                <em>already</em> moved up or down compared to the window open price.
                <br><br>
                <b>Why it works:</b> with only 10 seconds left, the direction is mostly locked in. If BTC is already
                up +0.10% from the window open, it's ~85%+ likely to stay UP through resolution.
                <br><br>
                <b>Trade-off:</b> tokens cost more near close ($0.70&ndash;$0.95 instead of ~$0.50), so profit per
                trade is smaller &mdash; but accuracy is much higher. Snipe runs as a <b>second pass</b> and won't
                duplicate a trade the ML model already placed.
                <br><br>
                Enable it in the sidebar: <b>Trading &rarr; Snipe mode</b>.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What is Arb-first mode?</summary>
              <div class="faq-a">
                Arb-first (arbitrage-first) is a <b>high-confidence</b> strategy. It watches the Polymarket
                orderbook and tries to buy <b>both UP and DOWN shares</b> when the combined cost is briefly
                below <b>$1.00</b>.
                <br><br>
                <b>Example:</b> if UP costs $0.48 and DOWN costs $0.49, that's $0.97 total. Since one side
                <em>must</em> pay out $1.00, you lock in ~$0.03 profit per dollar spent, regardless of the outcome.
                <br><br>
                These opportunities are rare and short-lived. The bot watches for them automatically when enabled.
                <br><br>
                Enable it in the sidebar: <b>Trading &rarr; Arb-first</b>. The <b>Min edge (cents)</b> control
                sets how big the discount must be before trading (higher = fewer but safer trades).
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What is USDC?</summary>
              <div class="faq-a">
                <b>USDC</b> (USD Coin) is a <b>stablecoin</b> cryptocurrency pegged 1:1 to the US Dollar.
                $5 USDC = $5 USD. It's what Polymarket uses for trading.
                <br><br>
                To fund your bot, you need to <b>deposit USDC onto the Polygon network</b> into your trading
                wallet address. You can buy USDC on exchanges like Coinbase, Kraken, or Binance, then withdraw
                to Polygon.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What is Polygon? What is gas / POL / MATIC?</summary>
              <div class="faq-a">
                <b>Polygon</b> is the blockchain network that Polymarket runs on. Think of it as the
                "highway" your trades travel on.
                <br><br>
                <b>Gas</b> is a small fee you pay to use the network (like a toll). The gas token is
                called <b>POL</b> (formerly MATIC). You need a tiny amount (~$1&ndash;$3 worth) in your
                wallet to pay for trade confirmations and redemptions.
                <br><br>
                If you see a <b>"Low gas"</b> warning, send a small amount of POL/MATIC to your bot wallet
                address. You can buy it on most crypto exchanges.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What is a private key? Is it safe to paste it?</summary>
              <div class="faq-a">
                A <b>private key</b> is like the master password to a crypto wallet. Whoever has it can spend
                the funds inside. That's why you should:
                <br><br>
                <b>1.</b> Use a <b>dedicated bot wallet</b> &mdash; never paste the key for your main wallet.<br>
                <b>2.</b> Only put small amounts ($10&ndash;50) in the bot wallet to start.<br>
                <b>3.</b> The key stays <b>only on your server</b> &mdash; it is never sent anywhere.<br>
                <b>4.</b> Get your Polymarket wallet key from
                <a href="https://reveal.magic.link/polymarket" target="_blank" rel="noopener">reveal.magic.link/polymarket</a>.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">How do I fund my bot wallet with USDC?</summary>
              <div class="faq-a">
                <b>Step 1:</b> Find your bot wallet address (shown in the dashboard sidebar or in the Setup Wizard).<br>
                <b>Step 2:</b> Buy USDC on an exchange (Coinbase, Kraken, Binance, etc.).<br>
                <b>Step 3:</b> Withdraw USDC to your bot wallet address on the <b>Polygon network</b>.
                <span class="danger">Make sure you select Polygon, NOT Ethereum</span> &mdash; sending to the wrong
                network means lost funds.<br>
                <b>Step 4:</b> Also send ~$1&ndash;$3 worth of <b>POL/MATIC</b> (gas token) to the same address.<br>
                <b>Step 5:</b> The bot will see the balance automatically within a minute or two.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">Docker says "permission denied" or won't start</summary>
              <div class="faq-a">
                <b>Windows:</b> Make sure <b>Docker Desktop</b> is installed and running (check the system tray
                for the whale icon). If it says "Docker daemon is not running", open Docker Desktop and wait
                for it to fully start.<br><br>
                <b>Linux:</b> You may need to add your user to the docker group:
                <span class="mono">sudo usermod -aG docker $USER</span>, then log out and back in.<br><br>
                <b>Mac:</b> Same as Windows &mdash; ensure Docker Desktop is installed from
                <a href="https://docker.com/products/docker-desktop/" target="_blank" rel="noopener">docker.com</a> and running.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">The dashboard won't load / I get "connection refused"</summary>
              <div class="faq-a">
                <b>1.</b> Is the container running? Check: <span class="mono">docker ps</span> &mdash; you should see
                <span class="mono">crypto5min-polytrader</span> in the list.<br>
                <b>2.</b> Is the port correct? Default is <b>8602</b>. Visit
                <span class="mono">http://YOUR_SERVER_IP:8602</span>.<br>
                <b>3.</b> Firewall: make sure port 8602 is open on your server. On a VPS, check your hosting
                provider's firewall rules.<br>
                <b>4.</b> If using Docker Desktop locally, try <span class="mono">http://localhost:8602</span>.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">Why does the bot skip some windows?</summary>
              <div class="faq-a">
                The bot skips a 5-minute window when:
                <br><br>
                <b>1.</b> Confidence is below your threshold (e.g., model is only 52% sure but threshold is 55%).<br>
                <b>2.</b> The cooldown hasn't expired since the last trade.<br>
                <b>3.</b> The market couldn't be found on Polymarket (it may not exist yet for that window).<br>
                <b>4.</b> Kelly sizing computed zero edge (model probability is below market price).<br>
                <br>
                Skipping is <b>normal and healthy</b> &mdash; it means the bot is being selective. You'll see
                "skipped" with a reason in the trade log.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">Can I run this on my laptop instead of a server?</summary>
              <div class="faq-a">
                <b>Yes!</b> Install Docker Desktop on Windows or Mac. The bot runs inside a container, so
                your laptop doesn't need Python or any special software beyond Docker.
                <br><br>
                <b>But:</b> if you close your laptop or it goes to sleep, the bot stops trading. For 24/7
                operation, a cheap VPS ($5&ndash;10/month on Hetzner, DigitalOcean, etc.) is recommended.
              </div>
            </details>

            {# ‚îÄ‚îÄ v0.3.0 FAQ entries ‚îÄ‚îÄ #}
            <details class="faq-item">
              <summary class="faq-q">What is the Chainlink oracle? Why does it matter?</summary>
              <div class="faq-a">
                Polymarket 5-minute BTC markets resolve using the <b>Chainlink BTC/USD Data Stream</b> &mdash; a price feed
                from a network of independent data providers. This is <b>different from Coinbase</b>.
                <br><br>
                <b>Why it matters:</b> In older versions, the bot only watched Coinbase prices to predict direction. But
                Polymarket uses Chainlink to decide winner/loser. Even a $50 difference between Coinbase and Chainlink
                at the 5-minute boundary could <b>flip the outcome</b>.
                <br><br>
                <b>What v0.3.0 does:</b> The bot now connects to Polymarket's free WebSocket and subscribes to the
                <em>exact same Chainlink price data</em> that Polymarket uses. Snipe mode compares Chainlink open vs
                Chainlink current &mdash; the exact same comparison Polymarket makes.
                If the Chainlink feed is temporarily unavailable, it falls back to Coinbase (same as before).
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What are Risk Rails?</summary>
              <div class="faq-a">
                Risk Rails are <b>automated safety limits</b> (circuit breakers) that pause the bot when things go wrong.
                They protect your capital while you're away from the dashboard.
                <br><br>
                There are four rails:
                <br><b>1. Daily Loss Limit</b> &mdash; pauses after losing X% of your balance in 24 hours (default: 10%)<br>
                <b>2. Consecutive Losses</b> &mdash; pauses after X losing trades in a row (default: 5)<br>
                <b>3. Unfilled Ratio</b> &mdash; pauses if too many orders go unfilled (default: 50% of last 20 orders)<br>
                <b>4. Auto-Resume</b> &mdash; automatically resumes after a pause period (default: 60 minutes)
                <br><br>
                All values are adjustable in the sidebar under <b>Risk Rails</b>. Set any value to <b>0</b> to disable that rail.
                Risk state persists across restarts.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What happens when risk rails pause trading?</summary>
              <div class="faq-a">
                The bot <b>stops placing new trades</b> but keeps running &mdash; it still shows predictions, monitors prices,
                and retrains the model. Existing orders are not affected.
                <br><br>
                You'll see a "paused" status on the dashboard. Trading resumes automatically after the <b>Auto-Resume</b>
                period (default 60 minutes), or you can manually resume by clicking Resume.
                <br><br>
                Risk state is saved to <b>logs/risk_state.json</b> and persists across container restarts.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What is the Edge Gate?</summary>
              <div class="faq-a">
                The Edge Gate is an optional filter that blocks ML trades unless the model's probability minus the
                market price is above a minimum threshold.
                <br><br>
                <b>Example:</b> If Edge Gate = 0.03, the model predicts 58% (p=0.58), and the market asks $0.56 (P=0.56),
                edge = 0.02 &lt; 0.03 &rarr; trade <b>blocked</b>. If the market asks $0.54, edge = 0.04 &gt; 0.03 &rarr; trade <b>allowed</b>.
                <br><br>
                <b>Snipe trades bypass</b> the edge gate &mdash; they use their own delta-based threshold.
                <br><br>
                Set it in the sidebar under <b>Timing &amp; edge</b>. Recommended: <b>0.02&ndash;0.05</b> for conservative trading.
                Set to <b>0</b> to disable (not recommended).
              </div>
            </details>

            {# ‚îÄ‚îÄ v0.4.0 FAQ entries ‚îÄ‚îÄ #}
            <details class="faq-item">
              <summary class="faq-q">What is Ensemble Scoring?</summary>
              <div class="faq-a">
                In v0.4.0 the final Up/Down prediction is a <b>blend</b> of two signals:
                <br><br>
                <b>1. ML Model:</b> The trained CNN-LSTM or LightGBM model that looks at 40+ features over past candles.<br>
                <b>2. Live Chainlink Delta:</b> The <em>actual</em> price movement from the Chainlink oracle since the 5-minute window opened.
                <br><br>
                The <b>Ensemble Weight</b> setting controls the blend: default <b>0.6</b> means 60% model + 40% Chainlink delta.
                This way the bot trusts what it learned <em>and</em> what's happening right now.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What is Platt Calibration?</summary>
              <div class="faq-a">
                ML models often output <b>overconfident or underconfident</b> probabilities. Platt Calibration (actually
                Isotonic Regression) adjusts the model's outputs so they match <em>real-world</em> outcomes.
                <br><br>
                <b>Before:</b> Model says 55% &rarr; actual win rate might be 48%.<br>
                <b>After:</b> Model says 55% &rarr; actual win rate is ~55%.
                <br><br>
                This is <b>automatic</b> &mdash; it activates when the model has 30+ training samples.
                No setting to toggle.
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What is the Hybrid Training Target?</summary>
              <div class="faq-a">
                <b>Problem:</b> The model used to train on Coinbase candle data, but Polymarket resolves markets
                using the <b>Chainlink oracle</b> &mdash; a different price feed. Small differences between them
                could flip the outcome.
                <br><br>
                <b>Fix (v0.4.0):</b> When the bot has collected enough Chainlink history (10+ data points),
                it switches the training target from Coinbase close to <b>Chainlink price changes</b>.
                Now the model learns to predict what Polymarket actually measures.
                <br><br>
                This activates <b>automatically</b> as the bot runs. In the first few hours it may still use
                Coinbase (not enough Chainlink data yet).
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What are Quiet Hours?</summary>
              <div class="faq-a">
                Optional UTC hours when the bot <b>skips ML trades</b>. Some hours have low
                liquidity or unpredictable BTC behavior (e.g. 3&ndash;5 AM UTC).
                <br><br>
                Set in the sidebar under <b>Timing &amp; edge &rarr; Quiet Hours (UTC)</b>.
                Enter comma-separated hours: <code>3,4,5</code> means 3:00&ndash;5:59 AM UTC.
                <br><br>
                <b>Snipe trades are never blocked</b> by quiet hours &mdash; they only fire on strong signals.
                Leave blank to keep all hours active (default).
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">How do I update the bot?</summary>
              <div class="faq-a">
                Look at the <b>bottom-left</b> of the sidebar. You'll see your <b>current version</b> and a <b>Check</b> button.
                <br><br>
                <b>Option 1 (recommended):</b> Click the <b>&#8635; Check</b> button. If an update is available, a green banner
                appears with release notes and an <b>"Apply Update"</b> button. Click it &mdash; the bot downloads and
                installs the update, then restarts automatically.
                <br><br>
                <b>Option 2 (manual):</b> Download the latest ZIP from the Whop product page. Stop your container,
                replace the files, rebuild, and restart:
                <pre>docker compose down
docker compose build --no-cache
docker compose up -d</pre>
              </div>
            </details>

            <details class="faq-item">
              <summary class="faq-q">What does "basis" mean in the trade log?</summary>
              <div class="faq-a">
                <b>Basis</b> is the difference between the Coinbase price and the Chainlink oracle price at the time of a trade,
                measured in <b>basis points</b> (1 bps = 0.01%).
                <br><br>
                <b>Example:</b> If Coinbase says $108,500 and Chainlink says $108,450, the basis is ~4.6 bps.
                <br><br>
                Small numbers are normal. Large divergences (&gt;10 bps) could indicate pricing anomalies.
                This metric helps you monitor whether the two feeds are staying in sync.
              </div>
            </details>
          </div>
        </div>

        {# ‚îÄ‚îÄ Quick Reference ‚îÄ‚îÄ #}
        <div class="card dual-section">
          <div class="hd">
            <h2>Quick Reference</h2>
            <span class="hd-badge">cheat sheet</span>
          </div>
          <div class="bd">
            <div class="small">
              <table>
                <tbody>
                  <tr><td class="nowrap muted w-160">Model</td><td>CNN-LSTM neural network (with LightGBM/LogReg fallback)</td></tr>
                  <tr><td class="nowrap muted">Input</td><td>30 days of candles &times; 42+ features (RSI, MACD, Bollinger, stochastics, ADX, OBV, multi-timeframe returns, volatility regime, time-of-day, etc.)</td></tr>
                  <tr><td class="nowrap muted">Candle size</td><td>5 minutes (from Coinbase)</td></tr>
                  <tr><td class="nowrap muted">Retrain cycle</td><td>Every hour (60 min)</td></tr>
                  <tr><td class="nowrap muted">Signal refresh</td><td>Every ~15 seconds between retrains (auto-refresh)</td></tr>
                  <tr><td class="nowrap muted">Trade frequency</td><td>1 trade per 5-minute window (max)</td></tr>
                  <tr><td class="nowrap muted">Market</td><td>BTC Up or Down 5m (Polymarket)</td></tr>
                  <tr><td class="nowrap muted">Oracle</td><td>Chainlink BTC/USD Data Stream (via Polymarket RTDS WebSocket) &mdash; same oracle Polymarket uses to resolve markets</td></tr>
                  <tr><td class="nowrap muted">Currency</td><td>USDC (equal to USD)</td></tr>
                  <tr><td class="nowrap muted">ML win rate</td><td>~52&ndash;55% (prediction model, not guaranteed)</td></tr>
                  <tr><td class="nowrap muted">Snipe win rate</td><td>~80&ndash;90%+ when triggered (observes price, not prediction)</td></tr>
                  <tr><td class="nowrap muted">Bet % caps</td><td>10% (default) / 50% (High-risk) / 100% (Expert/UNSAFE)</td></tr>
                  <tr><td class="nowrap muted">Risk rails</td><td>Daily loss 10% / consec 5 / unfilled 50% / auto-resume 60 min (all adjustable)</td></tr>
                  <tr><td class="nowrap muted">Order type</td><td>Fill-or-Kill (FOK) market orders &mdash; instant fill at best price or cancel. Amounts auto-rounded to API precision. GTC retry as fallback.</td></tr>
                  <tr><td class="nowrap muted">Edge gate</td><td>Default <b>0.03</b>. Set 0.02&ndash;0.05 for conservative ML filtering. Set 0 to disable.</td></tr>
                  <tr><td class="nowrap muted">Ensemble weight</td><td>Default <b>0.6</b> (60% model + 40% Chainlink live delta)</td></tr>
                  <tr><td class="nowrap muted">Calibration</td><td>Automatic (Isotonic Regression, activates at 30+ samples)</td></tr>
                  <tr><td class="nowrap muted">Hybrid target</td><td>Automatic (trains on Chainlink when 10+ data points collected)</td></tr>
                  <tr><td class="nowrap muted">Quiet hours</td><td>Off by default. Set UTC hours to skip ML trades (snipe unaffected).</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        {# ‚îÄ‚îÄ Advanced Operations ‚îÄ‚îÄ #}
        <div class="card dual-section">
          <div class="hd">
            <h2>Advanced</h2>
            <span class="hd-badge danger">caution</span>
          </div>
          <div class="bd">

            {# Redeem #}
            <div class="small mb-10"><b>Redeem winnings</b> <span class="danger">(on-chain)</span></div>
            <div class="small mb-10">
              After markets resolve, winnings must be <b>redeemed</b> on-chain (Polygon) to return collateral.
              This sends a transaction and costs gas. Auto-redeem is enabled by default (you can disable it).
            </div>
            <form id="redeemForm" class="form-compact">
              <button type="submit">Preview redeem</button>
            </form>
            <form id="redeemConfirmForm" class="form-compact mt-8">
              <input name="confirm" placeholder="Type: I understand" />
              <button type="submit">Redeem now</button>
            </form>
            <div id="redeemResult" class="small mt-10 mono"></div>

            <div class="hr mt-14"></div>

            {# Gas top-up #}
            <div class="small mb-10"><b>Top up gas</b> <span class="danger">(POL/MATIC)</span></div>
            <div class="small mb-10">
              If gas is low, redeems/withdrawals can fail.
              <b>Easiest fix:</b> send ~$1‚Äì$3 worth of <span class="mono">POL/MATIC</span> to your bot wallet.
              <span class="muted">This tool is optional/advanced: it can swap a small amount of USDC into gas, but it still needs a little gas already.</span>
            </div>
            <form id="gasTopupForm" class="form-compact">
              <button type="submit">Preview gas top-up</button>
            </form>
            <form id="gasTopupConfirmForm" class="form-compact mt-8">
              <input name="confirm" placeholder="Type: I understand" />
              <button type="submit">Top up gas now</button>
            </form>
            <div id="gasTopupResult" class="small mt-10 mono"></div>

            <script>
              (function(){
                var form = document.getElementById('gasTopupForm');
                var cform = document.getElementById('gasTopupConfirmForm');
                var out = document.getElementById('gasTopupResult');
                if (!form || !cform || !out) return;
                function post(url, data){
                  return fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams(data||{}), credentials:'same-origin' })
                    .then(function(r){ return r.text().then(function(txt){ try { return { ok:r.ok, json:JSON.parse(txt) }; } catch(e) { return { ok:false, json:{error:txt} }; } }); });
                }
                form.addEventListener('submit', function(ev){
                  ev.preventDefault();
                  out.textContent = 'Loading preview...';
                  post('/gas/topup/preview', {}).then(function(res){
                    if (!res.ok) { out.innerHTML = '<span class="danger">' + (res.json.error || 'Error') + '</span>'; return; }
                    if (res.json.skipped) { out.innerHTML = '<span class="muted">No top-up needed.</span>'; return; }
                    if (!res.json.ok) { out.innerHTML = '<span class="danger">' + (res.json.hint || res.json.error || 'Cannot top up') + '</span>'; return; }
                    var usdc = res.json.estimated_usdc;
                    var need = res.json.need_native;
                    out.innerHTML = '<span class="up">OK</span> need ~' + (need||0).toFixed(4) + ' ' + (res.json.native_symbol||'POL') + (usdc ? (' (est $' + Number(usdc).toFixed(2) + ' USDC)') : '');
                  });
                });
                cform.addEventListener('submit', function(ev){
                  ev.preventDefault();
                  var confirm = (cform.querySelector('[name=confirm]').value||'').trim();
                  if (confirm.toLowerCase() !== 'i understand') { out.textContent = 'Type "I understand" to confirm.'; return; }
                  out.textContent = 'Submitting...';
                  post('/gas/topup/confirm', { confirm: 'I understand' }).then(function(res){
                    if (res.ok && res.json.ok) {
                      out.innerHTML = '<span class="up">OK</span> swap tx: <span class="clip">' + (res.json.swap_tx_hash||'') + '</span>';
                      if (res.json.approve_tx_hash) out.innerHTML += '<br><span class="muted">approve:</span> <span class="clip">' + res.json.approve_tx_hash + '</span>';
                    } else {
                      out.innerHTML = '<span class="danger">' + (res.json.hint || res.json.error || 'Failed') + '</span>';
                      if (res.json.detail) out.innerHTML += '<br><span class="muted">' + JSON.stringify(res.json.detail).slice(0, 300) + '</span>';
                    }
                  });
                });
              })();
            </script>

            <script>
              (function(){
                var form = document.getElementById('redeemForm');
                var cform = document.getElementById('redeemConfirmForm');
                var out = document.getElementById('redeemResult');
                if (!form || !cform || !out) return;
                function post(url, data){
                  return fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams(data||{}), credentials:'same-origin' })
                    .then(function(r){ return r.text().then(function(txt){ try { return { ok:r.ok, json:JSON.parse(txt) }; } catch(e) { return { ok:false, json:{error:txt} }; } }); });
                }
                form.addEventListener('submit', function(ev){
                  ev.preventDefault();
                  out.textContent = 'Loading preview...';
                  post('/poly/redeem/preview', {}).then(function(res){
                    if (!res.ok) { out.innerHTML = '<span class="danger">' + (res.json.error || 'Error') + '</span>'; return; }
                    var c = (res.json.candidates || []);
                    var enabled = !!res.json.enabled;
                    if (!enabled) {
                      out.innerHTML = '<span class="danger">Auto-redeem is OFF</span>. Turn it on in the sidebar (Trading ‚Üí Auto-redeem).';
                      if (c.length) out.innerHTML += '<br><span class="muted">Found ' + c.length + ' win(s) eligible.</span>';
                      return;
                    }
                    if (!c.length) { out.innerHTML = '<span class="muted">Nothing to redeem right now.</span>'; return; }
                    out.innerHTML = '<span class="up">Eligible wins:</span> ' + c.length + '<br>' + c.slice(0,8).map(function(x){ return '<span class="clip">' + (x.window_slug||'') + '</span>'; }).join('<br>');
                  });
                });
                cform.addEventListener('submit', function(ev){
                  ev.preventDefault();
                  var confirm = (cform.querySelector('[name=confirm]').value||'').trim();
                  if (confirm.toLowerCase() !== 'i understand') { out.textContent = 'Type "I understand" to confirm.'; return; }
                  out.textContent = 'Redeeming...';
                  post('/poly/redeem/confirm', { confirm: 'I understand' }).then(function(res){
                    if (!res.ok) { out.innerHTML = '<span class="danger">' + (res.json.error || 'Failed') + '</span>'; return; }
                    out.innerHTML = '<span class="up">OK</span> redeemed: ' + (res.json.count || 0);
                  });
                });
              })();
            </script>

            <div class="hr mt-14"></div>

            {# Withdraw #}
            {% if withdraw_cfg and withdraw_cfg.enabled %}
              <div class="small mb-10"><b>Withdraw funds</b></div>
              <div class="small mb-10">Send USDC from your trading wallet to your personal wallet.</div>
              <div class="kpi mb-10">
                <div class="metric">
                  <div class="label">To address</div>
                  <div class="value mono fs-11 clip">{{ withdraw_cfg.to_address }}</div>
                </div>
                <div class="metric">
                  <div class="label">Max per tx</div>
                  <div class="value mono">${{ '%.0f'|format(withdraw_cfg.max_usdc) }}</div>
                </div>
              </div>

              <form id="withdrawForm" class="form-compact">
                <input name="amount_usdc" placeholder="Amount USDC (e.g. 10)" />
                <input name="confirm" placeholder="Type: I understand" />
                <button type="submit">Withdraw</button>
              </form>
              <div id="withdrawResult" class="small mt-10 mono"></div>

              <script>
                (function(){
                  var form = document.getElementById('withdrawForm');
                  var out = document.getElementById('withdrawResult');
                  if (!form || !out) return;
                  function post(url, data){
                    return fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams(data), credentials:'same-origin' })
                      .then(function(r){ return r.text().then(function(txt){ try { return { ok:r.ok, json:JSON.parse(txt) }; } catch(e) { return { ok:false, json:{error:txt} }; } }); });
                  }
                  form.addEventListener('submit', function(ev){
                    ev.preventDefault();
                    var amount = (form.querySelector('[name=amount_usdc]').value||'').trim();
                    var confirm = (form.querySelector('[name=confirm]').value||'').trim();
                    if (!amount || parseFloat(amount) <= 0) { out.textContent = 'Enter an amount.'; return; }
                    out.textContent = 'Checking...';
                    post('/withdraw/preview', { amount_usdc: amount }).then(function(prev){
                      if (!prev.ok) { out.innerHTML = '<span class="danger">' + (prev.json.error || 'Error') + '</span>'; return; }
                      if (confirm.toLowerCase() !== 'i understand') { out.textContent = 'Preview OK: $' + amount + '. Type "I understand" to confirm.'; return; }
                      out.textContent = 'Sending...';
                      post('/withdraw/confirm', { amount_usdc: amount, confirm: 'I understand' }).then(function(conf){
                        if (conf.ok) { out.innerHTML = '<span class="up">OK Sent $' + amount + '</span> tx: <span class="clip">' + (conf.json.tx_hash||'') + '</span>'; }
                        else { out.innerHTML = '<span class="danger">' + (conf.json.error || 'Failed') + '</span>'; }
                      });
                    });
                  });
                })();
              </script>

              <div class="hr mt-14"></div>

              <div class="small mb-10"><b>Withdraw all</b> <span class="danger">(capped at ${{ '%.0f'|format(withdraw_cfg.max_usdc) }})</span></div>
              <form id="withdrawAllForm" class="form-compact">
                <input name="confirm" placeholder="Type: I understand" />
                <button type="submit">Withdraw all</button>
              </form>
              <div id="withdrawAllResult" class="small mt-10 mono"></div>
              <script>
                (function(){
                  var form = document.getElementById('withdrawAllForm');
                  var out = document.getElementById('withdrawAllResult');
                  if (!form || !out) return;
                  function post(url,data){ return fetch(url,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams(data||{}),credentials:'same-origin'}).then(function(r){return r.text().then(function(t){try{return{ok:r.ok,json:JSON.parse(t)};}catch(e){return{ok:false,json:{error:t}};}});}); }
                  form.addEventListener('submit', function(ev){
                    ev.preventDefault();
                    var confirm = (form.querySelector('[name=confirm]').value||'').trim();
                    out.textContent = 'Checking...';
                    post('/withdraw/all/preview', {}).then(function(prev){
                      if (!prev.ok) { out.innerHTML = '<span class="danger">'+(prev.json.error||'Error')+'</span>'; return; }
                      if (confirm.toLowerCase() !== 'i understand') { out.textContent = 'Preview OK. Type "I understand" to confirm.'; return; }
                      out.textContent = 'Sending...';
                      post('/withdraw/all/confirm', { confirm:'I understand' }).then(function(conf){
                        if (conf.ok) { out.innerHTML = '<span class="up">OK Sent $'+(conf.json.sent_usdc||0)+'</span>'; } else { out.innerHTML = '<span class="danger">'+(conf.json.error||'Failed')+'</span>'; }
                      });
                    });
                  });
                })();
              </script>

              <div class="hr mt-14"></div>
            {% endif %}

            <div class="small mb-10"><b>Sell all positions</b> <span class="danger">(emergency)</span></div>
            <form id="sellAllForm" class="form-compact">
              <input name="confirm" placeholder="Type: SELL ALL" />
              <button type="submit">Sell all</button>
            </form>
            <div id="sellAllResult" class="small mt-10 mono"></div>
            <script>
              (function(){
                var form = document.getElementById('sellAllForm');
                var out = document.getElementById('sellAllResult');
                if (!form || !out) return;
                form.addEventListener('submit', function(ev){
                  ev.preventDefault();
                  var confirm = (form.querySelector('[name=confirm]').value||'').trim();
                  out.textContent = 'Submitting...';
                  fetch('/poly/sell_all', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams({confirm:confirm}), credentials:'same-origin' })
                    .then(function(r){ return r.text(); })
                    .then(function(txt){ var json; try { json = JSON.parse(txt); } catch(e) { json = {raw:txt}; } out.textContent = JSON.stringify(json, null, 2); })
                    .catch(function(e){ out.textContent = String(e); });
                });
              })();
            </script>

            {% if not withdraw_cfg or not withdraw_cfg.enabled %}
              <div class="hr mt-14"></div>
              <div class="small">
                Withdraw is not set up yet. <a href="/reconfigure">Re-run the setup wizard</a> to add your personal wallet address.
              </div>
            {% endif %}
          </div>
        </div>
      </div>

    </div><!-- /main-content -->
  </div><!-- /dashboard-layout -->

  <!-- Tab switching -->
  <script>
    (function(){
      var btns = document.querySelectorAll('.tab-btn');
      var panels = document.querySelectorAll('.tab-panel');
      btns.forEach(function(btn){
        btn.addEventListener('click', function(){
          var target = btn.getAttribute('data-tab');
          btns.forEach(function(b){ b.classList.remove('active'); });
          panels.forEach(function(p){ p.classList.remove('active'); });
          btn.classList.add('active');
          var panel = document.getElementById(target);
          if (panel) panel.classList.add('active');
        });
      });
    })();
  </script>

  <!-- Auto-update checker -->
  <script>
  (function(){
    var banner = document.getElementById('update-banner');
    var versionInfo = document.getElementById('update-version-info');
    var notes = document.getElementById('update-notes');
    var approveBtn = document.getElementById('update-approve-btn');
    var progress = document.getElementById('update-progress');
    var progressFill = document.getElementById('update-progress-fill');
    var progressText = document.getElementById('update-progress-text');
    if (!banner) return;

    // Check for updates every 30 minutes + on load (after 10s delay)
    var CHECK_INTERVAL = 30 * 60 * 1000;
    var _updateData = null;

    function checkUpdate() {
      fetch('/api/update/check', {credentials: 'same-origin'})
        .then(function(r) { if (!r.ok) throw new Error(r.status); return r.json(); })
        .then(function(data) {
          if (data.error || !data.current) return; // bad response, ignore
          if (data.update_available) {
            _updateData = data;
            versionInfo.textContent = 'v' + data.current + ' ‚Üí v' + data.latest;
            notes.textContent = data.release_notes || 'No release notes.';
            banner.style.display = 'block';
          } else {
            banner.style.display = 'none';
          }
        })
        .catch(function() { /* silent */ });
    }

    setTimeout(checkUpdate, 10000);
    setInterval(checkUpdate, CHECK_INTERVAL);

    // Manual "Check for Updates" button
    window.manualCheckUpdate = function() {
      var btn = document.getElementById('check-update-btn');
      var result = document.getElementById('update-check-result');
      if (!btn || !result) return;
      btn.disabled = true;
      btn.textContent = '‚ü≥ ...';
      result.style.display = 'block';
      result.textContent = 'Checking...';
      result.style.color = 'var(--muted)';

      fetch('/api/update/check', {credentials: 'same-origin'})
        .then(function(r) { if (!r.ok) throw new Error(r.status); return r.json(); })
        .then(function(data) {
          btn.disabled = false;
          btn.textContent = '‚ü≥ Check';
          if (data.error) {
            result.innerHTML = '<span style="color:var(--red)">Update check failed: ' + data.error + '</span>';
            setTimeout(function(){ result.style.display = 'none'; }, 5000);
            return;
          }
          if (data.update_available) {
            result.innerHTML = '<span style="color:var(--mint)">&#10003; Update available: v' + data.current + ' ‚Üí v' + data.latest + '</span>';
            // Also trigger the banner
            _updateData = data;
            versionInfo.textContent = 'v' + data.current + ' ‚Üí v' + data.latest;
            notes.textContent = data.release_notes || 'No release notes.';
            banner.style.display = 'block';
          } else {
            result.innerHTML = '<span style="color:var(--mint)">&#10003; You\'re on the latest version (v' + (data.current || '?') + ')</span>';
            setTimeout(function(){ result.style.display = 'none'; }, 5000);
          }
        })
        .catch(function() {
          btn.disabled = false;
          btn.textContent = '‚ü≥ Check';
          result.innerHTML = '<span style="color:var(--red)">Could not reach update server</span>';
          setTimeout(function(){ result.style.display = 'none'; }, 5000);
        });
    };

    // Approve & apply
    window.approveUpdate = function() {
      if (!confirm('Apply update to v' + (_updateData ? _updateData.latest : '?') + '?\n\nYour config, data, and logs will be preserved.\nThe bot will restart briefly.')) return;
      approveBtn.disabled = true;
      approveBtn.textContent = 'Updating...';
      progress.style.display = 'block';
      progressFill.style.width = '30%';
      progressText.textContent = 'Downloading...';

      fetch('/api/update/apply', {method:'POST', credentials:'same-origin'})
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.error) {
            alert('Update error: ' + data.error);
            approveBtn.disabled = false;
            approveBtn.textContent = 'Update now';
            progress.style.display = 'none';
            return;
          }
          // Poll status
          pollStatus();
        })
        .catch(function(err) {
          alert('Update request failed: ' + err);
          approveBtn.disabled = false;
          approveBtn.textContent = 'Update now';
          progress.style.display = 'none';
        });
    };

    function pollStatus() {
      fetch('/api/update/status', {credentials:'same-origin'})
        .then(function(r) { return r.json(); })
        .then(function(s) {
          if (s.state === 'downloading') {
            progressFill.style.width = '40%';
            progressText.textContent = 'Downloading update...';
            setTimeout(pollStatus, 2000);
          } else if (s.state === 'applying') {
            progressFill.style.width = '70%';
            progressText.textContent = 'Applying update...';
            setTimeout(pollStatus, 2000);
          } else if (s.state === 'done') {
            progressFill.style.width = '100%';
            progressText.textContent = 'Update complete! Restarting...';
            approveBtn.textContent = 'Done ‚úì';
            // Page will reload when container restarts
            setTimeout(function(){ location.reload(); }, 8000);
          } else if (s.state === 'error') {
            progressText.textContent = 'Error: ' + (s.message || 'Unknown');
            progressFill.style.width = '100%';
            progressFill.style.background = 'var(--red)';
            approveBtn.disabled = false;
            approveBtn.textContent = 'Retry';
          } else {
            setTimeout(pollStatus, 3000);
          }
        })
        .catch(function() {
          // Server went down (restarting) ‚Äî wait and reload
          progressFill.style.width = '90%';
          progressText.textContent = 'Restarting...';
          setTimeout(function(){ location.reload(); }, 10000);
        });
    }
  })();
  </script>
{% endblock %}
