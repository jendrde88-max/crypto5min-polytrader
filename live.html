{% set snap = live.get('snapshot') %}

{# ── Window Countdown ── #}
<div class="kpi section-gap">
  <div class="metric full">
    <div class="window-row">
      <div>
        <div class="label">Current Window</div>
        <div class="value mono fs-14">{{ live.get('window_slug', '') }}</div>
      </div>
      <div class="window-row-right">
        <div class="label">Countdown</div>
        <div id="windowCountdown" class="value mono gold countdown-big">
          {{ '%d:%02d' | format(live.get('window_seconds_remaining',0)//60, live.get('window_seconds_remaining',0)%60) }}
        </div>
      </div>
    </div>
    <div class="progress-track">
      <div id="windowBar" class="progress-fill"></div>
    </div>
    <div class="small trade-zone-label">
      {% if live.get('is_trade_time') %}
        <span class="mono pulse up">● TRADE ZONE</span> — placing orders now
      {% else %}
        <span class="mono muted">○ waiting</span> — next trade in ~{{ live.get('window_seconds_remaining',0) }}s
      {% endif %}
    </div>
  </div>
</div>

<script>
  (function(){
    // Clear any previous interval (HTMX re-renders this partial every 5s; without this
    // each render spawns a new setInterval causing the bar to flash and jump).
    if (window._c5CountdownIv) { clearInterval(window._c5CountdownIv); window._c5CountdownIv = null; }
    var rem = {{ live.get('window_seconds_remaining', 300) }};
    var total = 300;
    var el = document.getElementById('windowCountdown');
    var bar = document.getElementById('windowBar');
    if (!el) return;
    // Sync bar to server-provided value immediately (no flash on first render)
    if (bar) bar.style.width = (((total - rem) / total) * 100).toFixed(1) + '%';
    window._c5CountdownIv = setInterval(function(){
      rem--;
      if (rem < 0) rem = 0;
      var m = Math.floor(rem/60);
      var s = rem % 60;
      el.textContent = m + ':' + (s < 10 ? '0' : '') + s;
      if (bar) bar.style.width = (((total - rem) / total) * 100).toFixed(1) + '%';
      if (rem <= 0) { clearInterval(window._c5CountdownIv); window._c5CountdownIv = null; }
    }, 1000);
  })();
</script>

{# ── Win/Loss Stats ── #}
<div class="kpi section-gap">
  <div class="metric">
    <div class="label">Win Rate (filled)</div>
    {% if live.get('total_filled', live.get('total_resolved', 0)) > 0 %}
      <div class="value mono {% if live.get('win_rate',0) >= 50 %}up{% else %}down{% endif %}">{{ '%.1f'|format(live.get('win_rate', 0)) }}%</div>
      <div class="small mt-6">{{ live.get('total_filled', live.get('total_resolved', 0)) }} filled trades</div>
    {% else %}
      <div class="value mono muted">—</div>
      <div class="small mt-6">no filled trades yet</div>
    {% endif %}
  </div>
  <div class="metric">
    <div class="label">W / L (filled)</div>
    <div class="value">
      <span class="mono up">{{ live.get('wins', 0) }}</span>
      <span class="mono muted"> / </span>
      <span class="mono down">{{ live.get('losses', 0) }}</span>
    </div>
    <div class="small mt-6">{{ live.get('wins',0) + live.get('losses',0) }} filled</div>
  </div>
  {% if live.get('wins_unfilled', 0) + live.get('losses_unfilled', 0) > 0 %}
  <div class="metric">
    <div class="label">Skipped (No Liq)</div>
    <div class="value mono muted">{{ live.get('wins_unfilled', 0) + live.get('losses_unfilled', 0) }}</div>
    <div class="small mt-6">orders not filled</div>
  </div>
  {% endif %}
</div>

{# ── Execution Status ── #}
<div class="kpi">
  <div class="metric">
    <div class="label">Execution</div>
    {% if live.get('really_trading') %}
      <div class="value"><span class="tag live">● LIVE</span></div>
    {% elif live.get('enabled') and live.get('dry_run') %}
      <div class="value"><span class="tag warn">◌ DRY-RUN</span></div>
    {% elif live.get('enabled') %}
      <div class="value"><span class="tag warn">◌ ENABLED</span></div>
    {% else %}
      <div class="value"><span class="tag off">— PAPER</span></div>
    {% endif %}
    <div class="small mt-6">
      max <span class="mono">${{ '%.2f'|format(live.get('max_usdc_per_trade', 0)) }}</span> / trade
    </div>
  </div>

  <div class="metric">
    <div class="label">Market</div>
    <div class="value mono fs-14">BTC · ETH · SOL · XRP</div>
    <div class="small mt-6">
      Up/Down 5m ·
      key {% if live.get('has_key') %}<span class="mono up">present</span>{% else %}<span class="mono danger">missing</span>{% endif %}
    </div>
  </div>

  <div class="metric">
    <div class="label">Account</div>
    {% if snap %}
      <div class="value mono gold">${{ '%.2f'|format(snap.get('total_equity_usdc', 0)) }}</div>
      <div class="small mt-6">
        bal <span class="mono">${{ '%.2f'|format(snap.get('clob_balance_usdc', 0)) }}</span> ·
        pos <span class="mono">${{ '%.2f'|format(snap.get('positions_value_usdc', 0)) }}</span>
      </div>
      {% if cfg.mode != 'paper' %}
      <div class="small">
        gas <span class="mono">{{ snap.get('native_gas_symbol', 'POL') }}</span>
        <span class="mono {% if snap.get('native_gas_balance', 0) >= live.get('native_gas_min', 0.15) %}up{% else %}danger{% endif %}">
          {{ '%.4f'|format(snap.get('native_gas_balance', 0)) }}
        </span>
        {% if snap.get('native_gas_balance', 0) < live.get('native_gas_min', 0.15) %}
          <span class="tag warn tag-sm">low</span>
        {% endif %}
      </div>
      {% endif %}
      <div class="small">
        P/L (since tracking)
        {% if live.get('equity_delta_usdc') is not none %}
          <span class="mono {% if live.get('equity_delta_usdc', 0) >= 0 %}up{% else %}down{% endif %}">
            ${{ '%.2f'|format(live.get('equity_delta_usdc', 0)) }}
          </span>
          {% if live.get('equity_delta_pct') is not none %}
            <span class="mono muted">({{ '%.2f'|format(live.get('equity_delta_pct', 0)) }}%)</span>
          {% endif %}
        {% else %}
          <span class="mono muted">—</span>
        {% endif %}
        · open positions <span class="mono">{{ snap.get('active_positions', 0) }}</span>
      </div>
      <div class="small">
        Position P/L (estimate)
        <span class="mono {% if (snap.get('unrealized_pnl_usdc', 0) >= 0) %}up{% else %}down{% endif %}">
          ${{ '%.2f'|format(snap.get('unrealized_pnl_usdc', 0)) }}
        </span>
        <span class="mono muted">· basis ${{ '%.2f'|format(snap.get('cost_basis_usdc', 0)) }}</span>
      </div>
    {% else %}
      <div class="value mono muted">—</div>
      <div class="small mt-6">No snapshot yet</div>
    {% endif %}
  </div>

  <div class="metric">
    <div class="label">Last trade</div>
    {% set t = live.get('last_trade') %}
    {% if t and t.get('ts') %}
      <div class="value mono fs-14">{{ live.get('last_trade_iso', '')|replace('T',' ')|replace('+00:00','Z') }}</div>
      <div class="small mt-6">
        {% if t.get('dry_run') %}<span class="tag warn tag-sm">dry</span>{% else %}<span class="tag live tag-sm">live</span>{% endif %}
        · <span class="mono">${{ '%.2f'|format(t.get('usdc', 0)) }}</span>
        {% if t.get('direction') %}· <span class="mono">{{ t.get('direction') }}</span>{% endif %}
      </div>
      {% if t.get('window_slug') %}
        <div class="small clip mono fs-11">{{ t.get('window_slug') }}</div>
      {% endif %}
    {% else %}
      <div class="value mono muted">—</div>
      <div class="small mt-6">No trade logged yet</div>
    {% endif %}
  </div>
</div>

{% if not live.get('has_key') %}
  <div class="small mt-12">
    To connect your Polymarket account, <a href="/reconfigure">run the setup wizard</a> or add your wallet key in the settings.
  </div>
{% endif %}
